import{_ as a,r as p,o as t,c as e,b as n,d as c,a as o,e as i}from"./app-WhMj9h_6.js";const l={},u=i(`<h1 id="流" tabindex="-1"><a class="header-anchor" href="#流" aria-hidden="true">#</a> 流</h1><p><code>stream</code>（流）是Node.js提供的又一个仅在服务区端可用的模块，流是一种抽象的数据结构。<code>Stream</code> 是一个抽象接口，Node 中有很多对象实现了这个接口。例如，对<code>http</code> 服务器发起请求的<code>request</code> 对象就是一个<code>Stream</code>，还有<code>stdout</code>（标准输出流）。</p><h2 id="为什么要在node中使用流" tabindex="-1"><a class="header-anchor" href="#为什么要在node中使用流" aria-hidden="true">#</a> 为什么要在node中使用流</h2><p>假设目前需要一个读写文件的操作，不用流的实现方式：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> water <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&#39;a.txt&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&#39;b.txt&#39;</span><span class="token punctuation">,</span> water<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>但使用这种方法有几个问题：</p><ul><li><p>占用内存，因为使用读写方式是把文件内容全部读入内存，然后再写入文件，对于小型的文本文件问题不大，但是遇到较大的比如音频、视频文件，动辄几个GB大的文件就非常吃内存了</p></li><li><p>处理数据量较大的文件时不能分块处理，导致速度慢</p></li></ul><p>而流可以把文件资源拆分成小块，一块一块的运输，资源就像水流一样进行传输，使用流的话上述功能可以这样写：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&#39;a.mp4&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建可读流</span>
<span class="token keyword">var</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&#39;b.mp4&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建可写流</span>

readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当有数据流出时，写入数据</span>
    writeStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当没有数据时，关闭数据流</span>
    writeStream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但这样写还是有一些问题的，如果说写入的速度跟不上读取的速度，有可能导致数据丢失。正常的情况应该是，写完一段，再读取下一段，如果没有写完的话，就让读取流先暂停，等写完再继续.</p><p>所以为了让可读流和可写流速度一致，就要用到流中必不可少的属性<code>pipe</code>了，<code>pipe</code>翻译过来意思是管道，顾名思义，就想上面的倒水一样，如果不用一根管子相连，A桶倒进B桶的水不会均速传输，可能会导致水的浪费，用pipe可以这样解决上述问题:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&#39;a.mp4&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>&#39;b<span class="token punctuation">.</span>mp4<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>需要特别注意的是，<code>pipe()</code> 只是可读流的方法，也就是说只能从可读流中通过pipe方法拷贝数据到可写流，反之则不行，写的时候要注意顺序</p><h2 id="流的四种类型" tabindex="-1"><a class="header-anchor" href="#流的四种类型" aria-hidden="true">#</a> 流的四种类型</h2><p>Stream提供了以下四种类型的流:</p><ul><li><p>Readable 可读流:可读流是对一个可以读取数据的源的抽象。<code>fs.createReadStream</code> 方法是一个可读流的例子。</p></li><li><p>Writable 可写流:可写流是对一个可以写入数据的目标的抽象。<code>fs.createWriteStream</code> 方法是一个可写流的例子。</p></li><li><p>Duplex 可读可写流,TCP socket 就属于这种</p></li><li><p>Transform 在读写过程中可以修改和变换数据的Duplex流,变换流是一种特殊的双向流，它会基于写入的数据生成可供读取的数据。例如使用 <code>zlib.createGzip</code> 来压缩数据。你可以把一个变换流想象成一个函数，这个函数的输入部分对应可写流，输出部分对应可读流</p></li></ul><h2 id="可读流" tabindex="-1"><a class="header-anchor" href="#可读流" aria-hidden="true">#</a> 可读流</h2><p>创建可读流的方式：</p><ul><li><p>使用 <code>stream</code> 模块的 <code>Readable</code> 创建一个可读流</p></li><li><p>使用 <code>fs.createReadStream</code> 创建可读文件流</p></li></ul><p><strong>使用 <code>fs.createReadStream</code> 创建可读文件流</strong></p><ul><li><p>第一个参数是读取文件的路径</p></li><li><p>第二个参数为 <code>options</code> 选项，其中有八个参数:</p><ul><li><p>flags：标识位，默认为 r</p></li><li><p>encoding：字符编码，默认为 null</p></li><li><p>fd：文件描述符，默认为 null</p></li><li><p>mode：权限位，默认为 0o666</p></li><li><p>autoClose：是否自动关闭文件，默认为 true</p></li><li><p>start：读取文件的起始位置</p></li><li><p>end：读取文件的（包含）结束位置</p></li><li><p>highWaterMark：最大读取文件的字节数，默认 64 * 1024， 每次读多少字节的数据</p></li></ul></li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&#39;./files/big.file&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">//文件系统标志</span>
    <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">//数据编码，如果调置了该参数，则读取的数据会自动解析</span>
    <span class="token comment">//如果没调置，则读取的数据会是 Buffer</span>
    <span class="token comment">//也可以通过 rs.setEncoding() 进行设置</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">//文件描述符，默认为null</span>
    <span class="token literal-property property">fd</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">//文件权限,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span>
    <span class="token comment">//文件读取的开始位置</span>
    <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">//文件读取的结束位置(包括结束位置)</span>
    <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>
    <span class="token comment">//读取缓冲区的大小，默认64K</span>
    <span class="token comment">// highWaterMark: 3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用 <code>stream</code> 模块的 <code>Readable</code> 创建一个可读流</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Readable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> inStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个可读流</span>

inStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;ABCDEFGHIJKLM&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向这个可读流输入数据</span>
inStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;NOPQRSTUVWXYZ&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

inStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有更多数据了</span>

inStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出到一个可写流</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的例子中在把该流连接到 <code>process.stdout</code> 之前，我们就已经推送了所有数据。接下可以试着推送数据。 我们可以通过在可读流配置中实现 <code>read()</code> 方法来达成这一目的：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> inStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;size&#39;</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentCharCode<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentCharCode <span class="token operator">&gt;</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

inStream<span class="token punctuation">.</span>currentCharCode <span class="token operator">=</span> <span class="token number">65</span>

inStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当使用者读取该可读流时，<code>read</code> 方法会持续被触发，我们不断推送字母。我们需要在某处停止该循环， 这就是为何我们放置了一个 <code>if</code> 语句以便在 <code>currentCharCode</code> 大于 90（代表 Z） 时推送一个 <code>null</code> 值</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//创建一个文件可读流</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&#39;./files/big.file&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">//文件系统标志</span>
    <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">//数据编码，如果调置了该参数，则读取的数据会自动解析</span>
    <span class="token comment">//如果没调置，则读取的数据会是 Buffer</span>
    <span class="token comment">//也可以通过 rs.setEncoding() 进行设置</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">//文件描述符，默认为null</span>
    <span class="token literal-property property">fd</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">//文件权限,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token number">0o666</span><span class="token punctuation">,</span>
    <span class="token comment">//文件读取的开始位置</span>
    <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">//文件读取的结束位置(包括结束位置)</span>
    <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>
    <span class="token comment">//读取缓冲区的大小，默认64K</span>
    <span class="token comment">// highWaterMark: 3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">//文件被打开时触发</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;open&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;文件打开&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//监听data事件，会让当前流切换到流动模式</span>
<span class="token comment">//当流中将数据传给消费者后触发</span>
<span class="token comment">//由于我们在上面配置了 highWaterMark 为 3字节，所以下面会打印多次。</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//流中没有数据可供消费者时触发</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;数据读取完毕&#39;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//读取数据出错时触发</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;读取错误&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//当文件被关闭时触发</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;文件关闭&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1秒后暂停读取， 再过2秒继续读以数据</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可读流中的两种模式：</p><ul><li><p>流动模式 ( flowing ) ：数据自动从系统底层读取，并通过事件，尽可能快地提供给应用程序</p></li><li><p>暂停模式 ( paused )，必须显式的调用 read() 读取数据</p></li></ul><p>暂停模式 切换到 流动模式的方式：</p><ul><li><p>添加 <code>data</code> 事件回调</p></li><li><p>调用 <code>resume()</code></p></li><li><p>调用 <code>pipe()</code></p></li></ul><p>流动模式 切换到 暂停模式:</p><ul><li><p>如果没有管道目标，调用 <code>pause()</code></p></li><li><p>如果有管道目标，移除所有管道目标，调用 <code>unpipe()</code> 移除多个管道目标</p></li></ul><h2 id="可写流" tabindex="-1"><a class="header-anchor" href="#可写流" aria-hidden="true">#</a> 可写流</h2><ol><li>使用 <code>stream</code> 模块的 <code>Writable</code> 类创建可写流</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> outStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>outStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>write</code> 方法接受三个参数</p><ul><li><p><code>chunk</code> 通常是一个 <code>buffer</code>，除非我们对流进行了特殊配置</p></li><li><p><code>encoding</code> 通常可以忽略。除非 <code>chunk</code> 被配置为不是 <code>buffer</code></p></li><li><p><code>callback</code> 方法是一个在我们完成数据处理后要执行的回调函数。它用来表示数据是否成功写入。若是写入失败，在执行该回调函数时需要传入一个错误对象</p></li></ul><ol start="2"><li>使用 <code>fs.createWriteStream</code> 方法创建可写的文流</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> outFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&#39;./files/test.txt&#39;</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="双工流-可读可写流" tabindex="-1"><a class="header-anchor" href="#双工流-可读可写流" aria-hidden="true">#</a> 双工流（可读可写流）</h2><p>通过 <code>stream</code> 的 <code>Duplex</code> 创建一个双工流</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Duplex <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> inoutStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Duplex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentCharCode<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentCharCode <span class="token operator">&gt;</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

inoutStream<span class="token punctuation">.</span>currentCharCode <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>inoutStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="变换流" tabindex="-1"><a class="header-anchor" href="#变换流" aria-hidden="true">#</a> 变换流</h2><p>通过<code>stream</code>的<code>Transform</code>创建一个双工流</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Transform <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> upperCaseTr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transform</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>upperCaseTr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个变换流中，我们只实现了 <code>transform()</code> 方法，却达到了前面双向流例子的效果。在该方法中，我们把 <code>chunk</code> 转换为大写然后通过 <code>push</code> 方法传递给下游。</p><h2 id="流事件和方法" tabindex="-1"><a class="header-anchor" href="#流事件和方法" aria-hidden="true">#</a> 流事件和方法</h2><p>以下是一些使用可读流或可写流时用到的事件和方法：</p><p><img src="https://user-gold-cdn.xitu.io/2017/6/14/03e1f627b419676dbb727ab9bc35e77e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p><p>这些事件和函数是相关的，因为我们总是把它们组合在一起使用</p><h3 id="可写流的一些方法" tabindex="-1"><a class="header-anchor" href="#可写流的一些方法" aria-hidden="true">#</a> 可写流的一些方法：</h3><ul><li><p><code>write</code> 方法</p><p><code>ws.write(chunk, [encoding], [callback]);</code></p><ul><li><p><code>chunk</code> 写入的数据 <code>buffer/string</code></p></li><li><p><code>encoding</code> 编码格式，<code>chunk</code> 为字符串时有用，是个可选参数</p></li><li><p><code>callback</code> 写入成功后的回调</p></li></ul><p>返回值为布尔值，系统缓存区满时为 <code>false</code>，未满时为 <code>true</code></p></li><li><p><code>end</code> 方法</p></li></ul><p><code>ws.end(chunk, [encoding], [callback]);</code></p><p>表明接下来没有数据要被写入 <code>Writable</code> 通过传入可选的 <code>chunk</code> 和 <code>encoding</code> 参数，可以在关闭流之前再写入一段数据 如果传入了可选的 <code>callback 函数</code>，它将作为 <code>finish</code> 事件的回调函数</p><p>可写流的一些事件：</p><ul><li><p><code>drain</code> 事件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;drain&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;drain&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>当一个流不处在 <code>drain</code> 的状态， 对 <code>write()</code> 的调用会缓存数据块， 并且返回 <code>false</code></p></li><li><p>当前所有缓存的数据块满了，满了之后情况才会触发 <code>drain</code></p></li><li><p>一旦 <code>write()</code> 返回 <code>false</code>， 在 <code>drain</code> 事件触发前， 不能写入任何数据块</p></li></ul></li><li><p><code>finish</code> 事件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;结束&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;finish&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;drain&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在调用 <code>end</code> 方法，且缓冲区数据都已经传给底层系统之后， <code>finish</code> 事件将被触发</p></li></ul><h3 id="一个可读流文件上的方法和事件" tabindex="-1"><a class="header-anchor" href="#一个可读流文件上的方法和事件" aria-hidden="true">#</a> 一个可读流文件上的方法和事件：</h3><p>一个可读流上的事件：</p><ul><li><p><code>open</code>事件上，当创建一个可读流时，会触发此事件</p></li><li><p><code>data</code> 事件，任何时候当可读流发送数据给它的消费者时，会触发此事件</p></li><li><p><code>end</code> 事件，当可读流没有更多的数据要发送给消费者时，会触发此事件</p></li><li><p><code>close</code>事件上，文件关闭时，触发</p></li></ul><p>一个可读流上的方法：</p><ul><li><p><code>pipe</code>：传送数据</p></li><li><p><code>unpipe</code>: 方法解绑之前使用 <code>pipe()</code> 方法绑定的可写流</p></li><li><p><code>pause</code>： 暂信传送数据</p></li><li><p><code>resume</code>: 继传传送数据</p></li><li><p><code>unshift</code>: 将 <code>chunk</code> 作为 <code>null</code> 传递信号表示流的末尾（EOF），其行为与 <code>readable.push(null)</code> 相同</p></li></ul><h2 id="可读流的暂停和流动模式" tabindex="-1"><a class="header-anchor" href="#可读流的暂停和流动模式" aria-hidden="true">#</a> 可读流的暂停和流动模式</h2><p>可读流有两种主要的模式，影响我们使用它的方式：</p><ul><li><p>它要么处于暂停模式</p></li><li><p>要么就是处于流动模式</p></li></ul><p>这些模式有时也被成为拉取和推送模式</p><p>所有的可读流默认都处于暂停模式。但它们可以按需在流动模式和暂停模式间切换。这种切换有时会自动发生。</p><p>当一个可读流处于暂停模式时，我们可以使用 <code>read()</code> 方法按需的读取数据。而对于一个处于流动模式的可读流，数据会源源不断的流动，我们需要通过事件监听来处理数据</p><p>在流动模式中，如果没有消费者监听事件那么数据就会丢失。这就是为何在处理流动模式的可读流时我们需要一个 <code>data</code>事件回调函数。事实上，通过增加一个 <code>data</code> 事件回调就可以把处于暂停模式的流切换到流动模式；同样的，移除 <code>data</code>事件回调会把流切回到暂停模式。这么做的一部分原因是为了和旧的 Node 流接口兼容。</p><p>要手动在这两个模式间切换，你可以使用 <code>resume()</code> 和 <code>pause()</code> 方法</p><p>当使用 <code>pipe</code> 方法时，它会自动帮你处理好这些模式之间的切换，因此你无须关心这些细节</p>`,72),d={href:"https://juejin.im/post/5940a9c3128fe1006a0ab176",target:"_blank",rel:"noopener noreferrer"};function r(k,v){const s=p("ExternalLinkIcon");return t(),e("div",null,[u,n("p",null,[n("a",d,[c("流"),o(s)])])])}const b=a(l,[["render",r],["__file","流.html.vue"]]);export{b as default};
