import{_ as n,o as s,c as a,e as p}from"./app-lkvzo8Ck.js";const e={},t=p(`<h1 id="tree-shaking" tabindex="-1"><a class="header-anchor" href="#tree-shaking" aria-hidden="true">#</a> Tree-Shaking</h1><p>Tree-shaking 的本质是消除无用的 js 模块。javascript 绝大多数情况需要通过网络进行加载，然后执行，加载的文件越小，整体执行时间越短。</p><p>消除无用代码广泛存在于传统的编程语言编译器中，编译器可以判断出某些代码根本不影响输出，然后消除这些代码，这个称之为DCE（dead code elimination）。Tree-shaking 是 DCE 的一种新的实现，</p><p>Tree-shaking 和传统的 DCE的方法又不太一样，传统的DCE 消灭不可能执行的代码，而Tree-shaking 更关注于消除没有用到的模块，网上很多文章会说是消除没有用到的代码，但是按照自己实践的效果来看总觉得 “消除没有用到的代码” 有点不准确</p><p><strong>Dead Code 一般具有以下几个特征</strong></p><ul><li><p>代码不会被执行，不可到达</p></li><li><p>代码执行的结果不会被用到</p></li><li><p>代码只会影响死变量（只写不读）</p></li></ul><h2 id="使用" tabindex="-1"><a class="header-anchor" href="#使用" aria-hidden="true">#</a> 使用</h2><p>配置 tree-shaking 需要两个条件：</p><ol><li>引入相关插件</li></ol><p>在 webpack 中， tree-shaking 的实现依靠 <code>terser-webpack-plugin</code>， 在 webpack4 及以上的版本中已经默认集成了 <code>TerserPlugin</code>, 通过 <code>optimization.minimizer</code> 配置开启，并且默认值情况下也是开启的...（啥也不用做）</p><ol start="2"><li><p>模块必须采用 ES6Module语法， 因为 tree-shaking 的实现依赖 ES6Module语法，所以在配置 babel 时，需要指定 <code>modules</code> 属性为 <code>true</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我这里使用 webpack5 , 安装的 babel 解析插件为 <code>&quot;@babel/preset-env&quot;: &quot;^7.12.10&quot;,</code>，默认 <code>modules: auto</code> ,即会使用 ES6Module 模式来处理JS，总之也不用特定指定 <code>&quot;modules&quot;: true</code> 就是了</p></li></ol><p>粟子：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 源代码</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> utils <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span>
<span class="token keyword">import</span> <span class="token string">&#39;./helper&#39;</span>
utils<span class="token punctuation">.</span><span class="token constant">MA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;fn1&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;fn2&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token constant">MA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;执行MA&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token constant">MB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;执行MB&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打包后的JS</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;style&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color: red&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;执行MA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">;</span>
    Math<span class="token punctuation">.</span><span class="token function">abc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;fn2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的结果可以觉得以下几个讯息：</p><ol><li><p><code>utils</code> 没用到的 <code>MB</code> 函数被删除了，入口文件 <code>fn1</code> 函数也被删除了，但是下面这两行代码仍然还在</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token keyword">new</span> <span class="token class-name">Object</span>
  Math<span class="token punctuation">.</span><span class="token function">abc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;fn2&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>import &#39;./helper&#39;</code> 虽然没有显性导出被使用，但是也是内部的方法被消除而已，<code>document.body.setAttribute(&quot;style&quot;, &quot;color: red&quot;)</code> 语句还在</p></li></ol><p>关于上面的两点下文会做进一步处理方式</p><p>综合以上两点我才会理解 Tree-shaking 是消除没用到的模块，而不是消除没用到的代码</p><h2 id="tree-shaking-实现原理" tabindex="-1"><a class="header-anchor" href="#tree-shaking-实现原理" aria-hidden="true">#</a> tree-shaking 实现原理</h2><p>tree-shaking 的消除原理是依赖于ES6的模块特性。ES6 module 特点：</p><ul><li><p>只能作为模块顶层的语句出现</p></li><li><p>import 的模块名只能是字符串常量</p></li><li><p>import binding 是 immutable的</p></li></ul><p>ES6模块依赖关系是确定的，和运行时的状态无关，可以进行可靠的静态分析，这就是 tree-shaking 的基础</p><p><strong>实现细节</strong></p><p>Webpack 负责对代码进行标记，把 <code>import &amp; export</code> 标记为三类：</p><ul><li><p>所有 import 标记为 <code>/* harmony import */</code></p></li><li><p>被使用过的 export 标记为 <code>/* harmony export ([type]) */</code>，其中 <code>[type]</code> 和 Webpack 内部有关，可能是 <code>binding</code>、<code>immutable</code> 等等。</p></li><li><p>没被使用过的 export 标记为 <code>/* unused harmony export [FuncName] */</code>，其中 <code>[FuncName]</code> 为 export 的方法名称</p></li></ul><p>通过以下配置可以查看上面的打包的文件效果：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;development&#39;</span><span class="token punctuation">,</span>
 <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以发现文件里就会多这些标志的出现</p><p>之后就是通过 <code>TerserPlugin</code> 对标记了 <code>unused</code> 模块进行删除</p><p>或者直接通过 <code>production</code> 模式打包，查看最终结果</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;production&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>实现原理可以简单的概况：</strong></p><ul><li><p>ES6 Module引入进行静态分析，故而编译的时候正确判断到底加载了那些模块</p></li><li><p>静态分析程序流，判断那些模块和变量未被使用或者引用，进而删除对应代码</p></li></ul><h2 id="其它注意项" tabindex="-1"><a class="header-anchor" href="#其它注意项" aria-hidden="true">#</a> 其它注意项</h2><p><strong>类的处理</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> Utils <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Utils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Util</span> <span class="token punctuation">{</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#39;foo&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#39;bar&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意到 Webpack 是对 Util 类整体进行标记的（标记为被使用），而不是分别针对两个方法。也因此，最终打包的代码依然会包含 <code>bar</code> 方法。这表明 Webpack TreeShaking 只处理顶层内容，例如类和对象内部都不会再被分别处理</p><p><strong>直接在最外层执行的内置方法</strong></p><p>对于上文中没有删除的 <code>console.log</code>、 <code>Math.abs</code> 方法，Webpack 好像是无法确定这些是否该删除，所以干脆是保留了，那我们该怎么告诉 Webpack 让他放心大胆的删除呢？</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">beautify</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 只是为了让输出文件可以换行，实现运行时不应该配制这个</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">pure_funcs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;console.log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Math.abs&quot;</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打包输出结果如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;style&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color: red&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>未显性导出使用的模块</strong></p><p>如上文中的 <code>import &#39;./helper&#39;</code></p><p>如果希望这个文件是可以完全删除的，可以通过在 <code>package.json</code> 配置 <code>sideEffects</code> 属性来控制，比如设置 <code>&quot;sideEffects&quot;: false</code>，表示所有代码都不包含副作用, 来告知 webpack，它可以安全地删除未用到的 <code>export</code> 文件代码，还可以进行更细致的配置</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>ES Modules 是静态处理的，在编译阶段可以确定模块的依赖关系，对未使用得模块进行标记，之后通过 TerserPlugin 插件这些没用到的模块进行删除</p>`,48),o=[t];function c(i,l){return s(),a("div",null,o)}const r=n(e,[["render",c],["__file","tree-shaking.html.vue"]]);export{r as default};
