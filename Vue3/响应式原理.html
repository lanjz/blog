<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>响应式原理 | Hello Wold</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/lanjz/assets/css/0.styles.5dda244b.css" as="style"><link rel="preload" href="/lanjz/assets/js/app.f0225df9.js" as="script"><link rel="preload" href="/lanjz/assets/js/2.5f61dcad.js" as="script"><link rel="preload" href="/lanjz/assets/js/183.ae7ecd14.js" as="script"><link rel="prefetch" href="/lanjz/assets/js/10.57d8144b.js"><link rel="prefetch" href="/lanjz/assets/js/100.d93794d9.js"><link rel="prefetch" href="/lanjz/assets/js/101.2851f517.js"><link rel="prefetch" href="/lanjz/assets/js/102.17db90f4.js"><link rel="prefetch" href="/lanjz/assets/js/103.230e5939.js"><link rel="prefetch" href="/lanjz/assets/js/104.60c48dc0.js"><link rel="prefetch" href="/lanjz/assets/js/105.4ed8241b.js"><link rel="prefetch" href="/lanjz/assets/js/106.cee55fed.js"><link rel="prefetch" href="/lanjz/assets/js/107.89e4e107.js"><link rel="prefetch" href="/lanjz/assets/js/108.c065f663.js"><link rel="prefetch" href="/lanjz/assets/js/109.f2b0c682.js"><link rel="prefetch" href="/lanjz/assets/js/11.7b71f2ad.js"><link rel="prefetch" href="/lanjz/assets/js/110.6d2cf8a6.js"><link rel="prefetch" href="/lanjz/assets/js/111.065d42c5.js"><link rel="prefetch" href="/lanjz/assets/js/112.b77a33cd.js"><link rel="prefetch" href="/lanjz/assets/js/113.a4184a08.js"><link rel="prefetch" href="/lanjz/assets/js/114.9de7482c.js"><link rel="prefetch" href="/lanjz/assets/js/115.e920758b.js"><link rel="prefetch" href="/lanjz/assets/js/116.58eef2fc.js"><link rel="prefetch" href="/lanjz/assets/js/117.9a92be3a.js"><link rel="prefetch" href="/lanjz/assets/js/118.1eecae25.js"><link rel="prefetch" href="/lanjz/assets/js/119.07c50b4b.js"><link rel="prefetch" href="/lanjz/assets/js/12.5c1b8034.js"><link rel="prefetch" href="/lanjz/assets/js/120.6b3a40fe.js"><link rel="prefetch" href="/lanjz/assets/js/121.4874fdbf.js"><link rel="prefetch" href="/lanjz/assets/js/122.133ebb39.js"><link rel="prefetch" href="/lanjz/assets/js/123.b97b0570.js"><link rel="prefetch" href="/lanjz/assets/js/124.1f51ea21.js"><link rel="prefetch" href="/lanjz/assets/js/125.61c6430a.js"><link rel="prefetch" href="/lanjz/assets/js/126.5f8753c3.js"><link rel="prefetch" href="/lanjz/assets/js/127.db4e7360.js"><link rel="prefetch" href="/lanjz/assets/js/128.71d1926b.js"><link rel="prefetch" href="/lanjz/assets/js/129.94e7e2bb.js"><link rel="prefetch" href="/lanjz/assets/js/13.7c7faa5f.js"><link rel="prefetch" href="/lanjz/assets/js/130.fdc878ee.js"><link rel="prefetch" href="/lanjz/assets/js/131.360b67a0.js"><link rel="prefetch" href="/lanjz/assets/js/132.3bd6aab7.js"><link rel="prefetch" href="/lanjz/assets/js/133.8a7c12c4.js"><link rel="prefetch" href="/lanjz/assets/js/134.d8848bc5.js"><link rel="prefetch" href="/lanjz/assets/js/135.c47a4abe.js"><link rel="prefetch" href="/lanjz/assets/js/136.2211724b.js"><link rel="prefetch" href="/lanjz/assets/js/137.59495f5e.js"><link rel="prefetch" href="/lanjz/assets/js/138.8bb1e8fe.js"><link rel="prefetch" href="/lanjz/assets/js/139.b1cf9739.js"><link rel="prefetch" href="/lanjz/assets/js/14.821d6c93.js"><link rel="prefetch" href="/lanjz/assets/js/140.0f0fd323.js"><link rel="prefetch" href="/lanjz/assets/js/141.26759d34.js"><link rel="prefetch" href="/lanjz/assets/js/142.ec05a22d.js"><link rel="prefetch" href="/lanjz/assets/js/143.bcdd9439.js"><link rel="prefetch" href="/lanjz/assets/js/144.d6663c18.js"><link rel="prefetch" href="/lanjz/assets/js/145.67f12433.js"><link rel="prefetch" href="/lanjz/assets/js/146.a5252632.js"><link rel="prefetch" href="/lanjz/assets/js/147.13e71abd.js"><link rel="prefetch" href="/lanjz/assets/js/148.56809342.js"><link rel="prefetch" href="/lanjz/assets/js/149.b65193ce.js"><link rel="prefetch" href="/lanjz/assets/js/15.9c62555c.js"><link rel="prefetch" href="/lanjz/assets/js/150.0c2a2667.js"><link rel="prefetch" href="/lanjz/assets/js/151.4946ca52.js"><link rel="prefetch" href="/lanjz/assets/js/152.efe6410d.js"><link rel="prefetch" href="/lanjz/assets/js/153.08035204.js"><link rel="prefetch" href="/lanjz/assets/js/154.db085db6.js"><link rel="prefetch" href="/lanjz/assets/js/155.3294222d.js"><link rel="prefetch" href="/lanjz/assets/js/156.5380280c.js"><link rel="prefetch" href="/lanjz/assets/js/157.5f652051.js"><link rel="prefetch" href="/lanjz/assets/js/158.d16f03ab.js"><link rel="prefetch" href="/lanjz/assets/js/159.c7790064.js"><link rel="prefetch" href="/lanjz/assets/js/16.ce05e904.js"><link rel="prefetch" href="/lanjz/assets/js/160.1b18b633.js"><link rel="prefetch" href="/lanjz/assets/js/161.2fc38c23.js"><link rel="prefetch" href="/lanjz/assets/js/162.67d98c97.js"><link rel="prefetch" href="/lanjz/assets/js/163.91992f11.js"><link rel="prefetch" href="/lanjz/assets/js/164.2a98f905.js"><link rel="prefetch" href="/lanjz/assets/js/165.7888496d.js"><link rel="prefetch" href="/lanjz/assets/js/166.5675af1a.js"><link rel="prefetch" href="/lanjz/assets/js/167.ad57c63a.js"><link rel="prefetch" href="/lanjz/assets/js/168.781ecc49.js"><link rel="prefetch" href="/lanjz/assets/js/169.cf8ac18e.js"><link rel="prefetch" href="/lanjz/assets/js/17.8865c20e.js"><link rel="prefetch" href="/lanjz/assets/js/170.e7fe3208.js"><link rel="prefetch" href="/lanjz/assets/js/171.abfc39b5.js"><link rel="prefetch" href="/lanjz/assets/js/172.cac23938.js"><link rel="prefetch" href="/lanjz/assets/js/173.a0ea92e0.js"><link rel="prefetch" href="/lanjz/assets/js/174.ad86bd44.js"><link rel="prefetch" href="/lanjz/assets/js/175.2738cc00.js"><link rel="prefetch" href="/lanjz/assets/js/176.24d932ed.js"><link rel="prefetch" href="/lanjz/assets/js/177.4e118a20.js"><link rel="prefetch" href="/lanjz/assets/js/178.90a17840.js"><link rel="prefetch" href="/lanjz/assets/js/179.cf51d488.js"><link rel="prefetch" href="/lanjz/assets/js/18.c42b8b12.js"><link rel="prefetch" href="/lanjz/assets/js/180.7ef48843.js"><link rel="prefetch" href="/lanjz/assets/js/181.4ec8a7bf.js"><link rel="prefetch" href="/lanjz/assets/js/182.ffef3c5c.js"><link rel="prefetch" href="/lanjz/assets/js/184.8e6aa0dd.js"><link rel="prefetch" href="/lanjz/assets/js/185.79f50f10.js"><link rel="prefetch" href="/lanjz/assets/js/186.640c56b1.js"><link rel="prefetch" href="/lanjz/assets/js/187.573ec635.js"><link rel="prefetch" href="/lanjz/assets/js/188.52821066.js"><link rel="prefetch" href="/lanjz/assets/js/189.2c3daca9.js"><link rel="prefetch" href="/lanjz/assets/js/19.976cc9c0.js"><link rel="prefetch" href="/lanjz/assets/js/190.27a10ce9.js"><link rel="prefetch" href="/lanjz/assets/js/191.d59071bb.js"><link rel="prefetch" href="/lanjz/assets/js/192.febde02b.js"><link rel="prefetch" href="/lanjz/assets/js/193.7d587588.js"><link rel="prefetch" href="/lanjz/assets/js/194.203841af.js"><link rel="prefetch" href="/lanjz/assets/js/195.f4b01157.js"><link rel="prefetch" href="/lanjz/assets/js/196.5e6d0757.js"><link rel="prefetch" href="/lanjz/assets/js/197.ac10b55c.js"><link rel="prefetch" href="/lanjz/assets/js/198.7e9ba9d4.js"><link rel="prefetch" href="/lanjz/assets/js/199.644f73be.js"><link rel="prefetch" href="/lanjz/assets/js/20.a939f41b.js"><link rel="prefetch" href="/lanjz/assets/js/200.31d830b3.js"><link rel="prefetch" href="/lanjz/assets/js/201.098f42e2.js"><link rel="prefetch" href="/lanjz/assets/js/202.d2b99cd4.js"><link rel="prefetch" href="/lanjz/assets/js/203.64f69ff3.js"><link rel="prefetch" href="/lanjz/assets/js/204.526c0d8c.js"><link rel="prefetch" href="/lanjz/assets/js/205.f59a2366.js"><link rel="prefetch" href="/lanjz/assets/js/206.7ef1b492.js"><link rel="prefetch" href="/lanjz/assets/js/207.197ba633.js"><link rel="prefetch" href="/lanjz/assets/js/208.acb4f1fe.js"><link rel="prefetch" href="/lanjz/assets/js/209.54e6a2e7.js"><link rel="prefetch" href="/lanjz/assets/js/21.fc790d04.js"><link rel="prefetch" href="/lanjz/assets/js/210.665f3c92.js"><link rel="prefetch" href="/lanjz/assets/js/211.701397c9.js"><link rel="prefetch" href="/lanjz/assets/js/212.71de1887.js"><link rel="prefetch" href="/lanjz/assets/js/213.9cb9e514.js"><link rel="prefetch" href="/lanjz/assets/js/214.fd45812e.js"><link rel="prefetch" href="/lanjz/assets/js/215.3079da19.js"><link rel="prefetch" href="/lanjz/assets/js/216.ee7d331b.js"><link rel="prefetch" href="/lanjz/assets/js/217.d5976054.js"><link rel="prefetch" href="/lanjz/assets/js/22.583281cd.js"><link rel="prefetch" href="/lanjz/assets/js/23.47b7387a.js"><link rel="prefetch" href="/lanjz/assets/js/24.7d471868.js"><link rel="prefetch" href="/lanjz/assets/js/25.6ee2bc5f.js"><link rel="prefetch" href="/lanjz/assets/js/26.7f59c89d.js"><link rel="prefetch" href="/lanjz/assets/js/27.50753467.js"><link rel="prefetch" href="/lanjz/assets/js/28.a423c60b.js"><link rel="prefetch" href="/lanjz/assets/js/29.1fad82d3.js"><link rel="prefetch" href="/lanjz/assets/js/3.e9dd142e.js"><link rel="prefetch" href="/lanjz/assets/js/30.e9a7f0f2.js"><link rel="prefetch" href="/lanjz/assets/js/31.783dd0c1.js"><link rel="prefetch" href="/lanjz/assets/js/32.a962168a.js"><link rel="prefetch" href="/lanjz/assets/js/33.151d1c4a.js"><link rel="prefetch" href="/lanjz/assets/js/34.5456707f.js"><link rel="prefetch" href="/lanjz/assets/js/35.ffc2a72e.js"><link rel="prefetch" href="/lanjz/assets/js/36.d45b4356.js"><link rel="prefetch" href="/lanjz/assets/js/37.7608a4a5.js"><link rel="prefetch" href="/lanjz/assets/js/38.1ae0f35b.js"><link rel="prefetch" href="/lanjz/assets/js/39.1e33eb2f.js"><link rel="prefetch" href="/lanjz/assets/js/4.d32690a0.js"><link rel="prefetch" href="/lanjz/assets/js/40.2a189049.js"><link rel="prefetch" href="/lanjz/assets/js/41.77ffd142.js"><link rel="prefetch" href="/lanjz/assets/js/42.2f1a367c.js"><link rel="prefetch" href="/lanjz/assets/js/43.0c53564a.js"><link rel="prefetch" href="/lanjz/assets/js/44.fd41c442.js"><link rel="prefetch" href="/lanjz/assets/js/45.0be7b00c.js"><link rel="prefetch" href="/lanjz/assets/js/46.1d143e5d.js"><link rel="prefetch" href="/lanjz/assets/js/47.a7058fa7.js"><link rel="prefetch" href="/lanjz/assets/js/48.c1afe546.js"><link rel="prefetch" href="/lanjz/assets/js/49.be202722.js"><link rel="prefetch" href="/lanjz/assets/js/5.cf5c1278.js"><link rel="prefetch" href="/lanjz/assets/js/50.daea8dab.js"><link rel="prefetch" href="/lanjz/assets/js/51.df2d8bf9.js"><link rel="prefetch" href="/lanjz/assets/js/52.2c332b91.js"><link rel="prefetch" href="/lanjz/assets/js/53.822c7657.js"><link rel="prefetch" href="/lanjz/assets/js/54.afd8f5dd.js"><link rel="prefetch" href="/lanjz/assets/js/55.e602cc3f.js"><link rel="prefetch" href="/lanjz/assets/js/56.4d52cf49.js"><link rel="prefetch" href="/lanjz/assets/js/57.b79a3026.js"><link rel="prefetch" href="/lanjz/assets/js/58.8fcc785d.js"><link rel="prefetch" href="/lanjz/assets/js/59.f551dbc8.js"><link rel="prefetch" href="/lanjz/assets/js/6.fa942886.js"><link rel="prefetch" href="/lanjz/assets/js/60.07cf0ce7.js"><link rel="prefetch" href="/lanjz/assets/js/61.d36916ee.js"><link rel="prefetch" href="/lanjz/assets/js/62.127e1e41.js"><link rel="prefetch" href="/lanjz/assets/js/63.24f9374b.js"><link rel="prefetch" href="/lanjz/assets/js/64.02e27d2b.js"><link rel="prefetch" href="/lanjz/assets/js/65.57193dce.js"><link rel="prefetch" href="/lanjz/assets/js/66.1e473047.js"><link rel="prefetch" href="/lanjz/assets/js/67.d531c0bf.js"><link rel="prefetch" href="/lanjz/assets/js/68.b4d7b0fd.js"><link rel="prefetch" href="/lanjz/assets/js/69.1c5b786c.js"><link rel="prefetch" href="/lanjz/assets/js/7.5fa14993.js"><link rel="prefetch" href="/lanjz/assets/js/70.bda28257.js"><link rel="prefetch" href="/lanjz/assets/js/71.aeb3f5b1.js"><link rel="prefetch" href="/lanjz/assets/js/72.078d46e4.js"><link rel="prefetch" href="/lanjz/assets/js/73.5be25e1e.js"><link rel="prefetch" href="/lanjz/assets/js/74.b66c6356.js"><link rel="prefetch" href="/lanjz/assets/js/75.b0a18839.js"><link rel="prefetch" href="/lanjz/assets/js/76.9b72d015.js"><link rel="prefetch" href="/lanjz/assets/js/77.14a98d54.js"><link rel="prefetch" href="/lanjz/assets/js/78.967159e3.js"><link rel="prefetch" href="/lanjz/assets/js/79.c3f7e943.js"><link rel="prefetch" href="/lanjz/assets/js/8.62cdd9d0.js"><link rel="prefetch" href="/lanjz/assets/js/80.372d1806.js"><link rel="prefetch" href="/lanjz/assets/js/81.7f07c97c.js"><link rel="prefetch" href="/lanjz/assets/js/82.fc8288c4.js"><link rel="prefetch" href="/lanjz/assets/js/83.6210c47f.js"><link rel="prefetch" href="/lanjz/assets/js/84.8a07e06c.js"><link rel="prefetch" href="/lanjz/assets/js/85.91f7f11a.js"><link rel="prefetch" href="/lanjz/assets/js/86.7826c6c3.js"><link rel="prefetch" href="/lanjz/assets/js/87.f6a7255c.js"><link rel="prefetch" href="/lanjz/assets/js/88.910d3c43.js"><link rel="prefetch" href="/lanjz/assets/js/89.f55e3352.js"><link rel="prefetch" href="/lanjz/assets/js/9.9e704394.js"><link rel="prefetch" href="/lanjz/assets/js/90.3fa36591.js"><link rel="prefetch" href="/lanjz/assets/js/91.c05e6c12.js"><link rel="prefetch" href="/lanjz/assets/js/92.737284fa.js"><link rel="prefetch" href="/lanjz/assets/js/93.93aaef91.js"><link rel="prefetch" href="/lanjz/assets/js/94.b65594e1.js"><link rel="prefetch" href="/lanjz/assets/js/95.fa0173af.js"><link rel="prefetch" href="/lanjz/assets/js/96.14482615.js"><link rel="prefetch" href="/lanjz/assets/js/97.ec4e8e9f.js"><link rel="prefetch" href="/lanjz/assets/js/98.1fffdf7d.js"><link rel="prefetch" href="/lanjz/assets/js/99.1f1465ef.js">
    <link rel="stylesheet" href="/lanjz/assets/css/0.styles.5dda244b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lanjz/" class="home-link router-link-active"><!----> <span class="site-name">Hello Wold</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lanjz/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/HTML5/" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/CSS/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Browser/" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络&amp;算法" class="dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络&amp;算法" class="mobile-dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/secure/" class="nav-link">
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Vue3/" class="nav-link router-link-active">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/qiankun/" class="nav-link">
  qiankun
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/NA/" class="nav-link">
  跨平台
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Node/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Api/" class="nav-link">
  API
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Package/" class="nav-link">
  yarn&amp;npm
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/ESBuild/" class="nav-link">
  esbuild
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/数据库/" class="nav-link">
  SQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端优化总结/" class="nav-link">
  前端优化总结
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/系统设计/" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/预加载&amp;预解析.html" class="nav-link">
  预加载&amp;预解析
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/重构改善既有代码的设计.html" class="nav-link">
  重构代码原则
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/开发与调试技巧.html" class="nav-link">
  开发与调试
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/组件设计的基本原则.html" class="nav-link">
  组件设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/公共模块管理.html" class="nav-link">
  公共模块管理
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/内存泄漏.html" class="nav-link">
  内存泄漏
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端异常捕获.html" class="nav-link">
  前端异常捕获
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/自动化部署.html" class="nav-link">
  自动化部署
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/疑难杂症.html" class="nav-link">
  问题小计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/性能指标.html" class="nav-link">
  性能指标
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="利其器" class="dropdown-title"><span class="title">利其器</span> <span class="arrow down"></span></button> <button type="button" aria-label="利其器" class="mobile-dropdown-title"><span class="title">利其器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Mac.html" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Github.html" class="nav-link">
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/lanjz/Im/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lanjz/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/HTML5/" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/CSS/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Browser/" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络&amp;算法" class="dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络&amp;算法" class="mobile-dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/secure/" class="nav-link">
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Vue3/" class="nav-link router-link-active">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/qiankun/" class="nav-link">
  qiankun
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/NA/" class="nav-link">
  跨平台
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Node/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Api/" class="nav-link">
  API
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Package/" class="nav-link">
  yarn&amp;npm
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/ESBuild/" class="nav-link">
  esbuild
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/数据库/" class="nav-link">
  SQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端优化总结/" class="nav-link">
  前端优化总结
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/系统设计/" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/预加载&amp;预解析.html" class="nav-link">
  预加载&amp;预解析
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/重构改善既有代码的设计.html" class="nav-link">
  重构代码原则
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/开发与调试技巧.html" class="nav-link">
  开发与调试
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/组件设计的基本原则.html" class="nav-link">
  组件设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/公共模块管理.html" class="nav-link">
  公共模块管理
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/内存泄漏.html" class="nav-link">
  内存泄漏
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端异常捕获.html" class="nav-link">
  前端异常捕获
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/自动化部署.html" class="nav-link">
  自动化部署
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/疑难杂症.html" class="nav-link">
  问题小计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/性能指标.html" class="nav-link">
  性能指标
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="利其器" class="dropdown-title"><span class="title">利其器</span> <span class="arrow down"></span></button> <button type="button" aria-label="利其器" class="mobile-dropdown-title"><span class="title">利其器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Mac.html" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Github.html" class="nav-link">
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/lanjz/Im/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/lanjz/Vue3/V3升级目的.html" class="sidebar-link">V3升级目的</a></li><li><a href="/lanjz/Vue3/使用区别.html" class="sidebar-link">Vue3相比Vue2使用差异</a></li><li><a href="/lanjz/Vue3/SFC还是JSX.html" class="sidebar-link">SCF还是JSX</a></li><li><a href="/lanjz/Vue3/createApp.html" class="sidebar-link">createApp</a></li><li><a href="/lanjz/Vue3/响应式原理.html" class="active sidebar-link">响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#vue3-0" class="sidebar-link">Vue3.0</a></li><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#过程分析" class="sidebar-link">过程分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#收集依赖" class="sidebar-link">收集依赖</a></li><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#触发更新" class="sidebar-link">触发更新</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#关于深度对象的监听" class="sidebar-link">关于深度对象的监听</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#如果是添加属性呢" class="sidebar-link">如果是添加属性呢？</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#数组类型的更新" class="sidebar-link">数组类型的更新</a></li><li class="sidebar-sub-header"><a href="/lanjz/Vue3/响应式原理.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/lanjz/Vue3/watch.html" class="sidebar-link">Watch</a></li><li><a href="/lanjz/Vue3/setup.html" class="sidebar-link">setup</a></li><li><a href="/lanjz/Vue3/响应式API.html" class="sidebar-link">粗读响应式API</a></li><li><a href="/lanjz/Vue3/Diff.html" class="sidebar-link">Diff</a></li><li><a href="/lanjz/Vue3/预渲染.html" class="sidebar-link">预渲染</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="响应式原理"><a href="#响应式原理" class="header-anchor">#</a> 响应式原理</h1> <p>回顾下 2.0 响应式原理实现过程：</p> <ol><li><p>Vue 在初始化的时候会遍历 <code>data</code> 数据，对于每个属性执行 <code>defineReactive</code> 方法，这里方法主要做以下两个事情：</p> <ul><li><p>实例化一个事件器 <code>Dep</code></p></li> <li><p>使用 <code>Obejct.definedPropery()</code> 方法代理属性并添加 <code>set</code> 和 <code>get</code> 方法， <code>get</code> 中添加了收集 <code>Watcher</code> 的逻辑，而 <code>set</code> 则是包含了执行 <code>Watcher</code> 的逻辑</p></li></ul></li> <li><p>在组件渲染的时候，会实例化一个 <code>Watcher</code> 实例，并将当前 <code>Watcher</code> 实例到全局属性 <code>Dep.target</code>中，之后在执行渲染操作的时候会读取 <code>data</code> 的属性， 并被 <code>get</code> 劫持，<code>get</code> 方法中将保存在全局的 <code>Watcher</code> 收集到 <code>dep</code> 中</p></li> <li><p>之后当 <code>data</code> 属性被更改时，会被 <code>set</code> 劫持，然后执行 <code>Watcher</code> 中的更新方法</p></li></ol> <h2 id="vue3-0"><a href="#vue3-0" class="header-anchor">#</a> Vue3.0</h2> <p>3.0 中改用了 Proxy 方法，以 <code>data</code> 属性为例来品一下怎么玩的</p> <p>源码追踪： <code>mountComponent(n2, container) =&gt; setupComponent(instance) =&gt; setupStatefulComponent() =&gt; finishComponentSetup(instance) =&gt; applyOptions(instance, Component) =&gt; resolveData(instance, dataOptions, publicThis)</code></p> <p><code>resolveData</code> 就是处理 <code>data</code> 属性的地方</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">resolveData</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> dataFn<span class="token punctuation">,</span> publicThis</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// data属性只能是函数 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>dataFn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The data option must be a function. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Plain object usage is no longer supported.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取 data 的值</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">dataFn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>publicThis<span class="token punctuation">,</span> publicThis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// data函数返回值不能是 Promise</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data() returned a Promise - note data() cannot be async; If you </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">intend to perform data fetching before component renders, use </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">async setup() + &lt;Suspense&gt;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// data函数返回值必需是对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data() should return an object.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 设置代理</span>
      instance<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// existing data: this is a mixin or extends.</span>
      <span class="token function">extend</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>上文对 <code>data</code> 属性和返回值做了一些校验后，执行 <code>reactive(data)</code> 方法设置代理</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if trying to observe a readonly proxy, return the readonly version.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span><span class="token string">&quot;__v_isReadonly&quot;</span> <span class="token comment">/* IS_READONLY */</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">,</span> mutableCollectionHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// reactive 实际上执行的是 `createReactiveObject` 方法</span>

  <span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> isReadonly<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">,</span> collectionHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value cannot be made reactive: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// target is already a Proxy, return it.</span>
    <span class="token comment">// exception: calling readonly() on a reactive object</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span><span class="token string">&quot;__v_raw&quot;</span> <span class="token comment">/* RAW */</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>isReadonly <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span><span class="token string">&quot;__v_isReactive&quot;</span> <span class="token comment">/* IS_REACTIVE */</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// target already has corresponding Proxy</span>
   <span class="token comment">// 使用 new WeakMap() 保存当前代理</span>
    <span class="token keyword">const</span> proxyMap <span class="token operator">=</span> isReadonly <span class="token operator">?</span> readonlyMap <span class="token operator">:</span> reactiveMap<span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果已经存在则是直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// only a whitelist of value types can be observed.</span>
    <span class="token keyword">const</span> targetType <span class="token operator">=</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">/* INVALID */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetType <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">/* COLLECTION */</span> <span class="token operator">?</span> collectionHandlers <span class="token operator">:</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>设置代理的地方： <code>const proxy = new Proxy(target, baseHandlers)</code>, <code>baseHandlers</code> 就是 Proxy 的处理器对象，根据上下文找到 <code>baseHandlers</code> 的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
    get<span class="token punctuation">,</span>
    set<span class="token punctuation">,</span>
    deleteProperty<span class="token punctuation">,</span>
    has<span class="token punctuation">,</span>
    ownKeys
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> get <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 设置 get 方法</span>
      <span class="token comment">// 如果当前访问 __v_isReactive 返回 true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&quot;__v_isReactive&quot;</span> <span class="token comment">/* IS_REACTIVE */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果当前访问 __v_isReadonly 返回 false</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&quot;__v_isReadonly&quot;</span> <span class="token comment">/* IS_READONLY */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> isReadonly<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果当前访问 __v_raw  从缓存中找对应的值，先不关心这个上</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&quot;__v_raw&quot;</span> <span class="token comment">/* RAW */</span> <span class="token operator">&amp;&amp;</span>
        receiver <span class="token operator">===</span> <span class="token punctuation">(</span>isReadonly <span class="token operator">?</span> readonlyMap <span class="token operator">:</span> reactiveMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果当前访问的数组中的属性，且是 ['includes', 'indexOf', 'lastIndexOf'] 中的一种,则调用重写的方法</span>
      <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> targetIsArray <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 获取属性对应的值</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">?</span> builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">:</span> key <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__proto__</span><span class="token template-punctuation string">`</span></span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__v_isRef</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行 track 方法，收集 effect 事件方法</span>
        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span> <span class="token comment">/* GET */</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ref unwrapping - does not apply for Array + integer key.</span>
        <span class="token keyword">const</span> shouldUnwrap <span class="token operator">=</span> <span class="token operator">!</span>targetIsArray <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> shouldUnwrap <span class="token operator">?</span> res<span class="token punctuation">.</span>value <span class="token operator">:</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Convert returned value into a proxy as well. we do the isObject check</span>
        <span class="token comment">// here to avoid invalid value warning. Also need to lazy access readonly</span>
        <span class="token comment">// and reactive here to avoid circular dependency.</span>
        <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 得到旧的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRef</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldValue<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>length
        <span class="token operator">:</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// don't trigger if target is something up in the prototype chain of original</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;add&quot;</span> <span class="token comment">/* ADD */</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 触发收集的事件，进行组件更新</span>
          <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span> <span class="token comment">/* SET */</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="过程分析"><a href="#过程分析" class="header-anchor">#</a> 过程分析</h2> <h3 id="收集依赖"><a href="#收集依赖" class="header-anchor">#</a> 收集依赖</h3> <p>当组件访问 <code>data</code> 中的属性时被 <code>get</code> 方法劫持，执行下面语句：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span> <span class="token comment">/* GET */</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// target 代理对象 属性</span>
<span class="token comment">// type get</span>
<span class="token comment">// key 要访问的属性</span>
  <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> activeEffect <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通过当前对象获取 dep</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果没有就添加</span>
      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通过属性获取 dep</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果没有添加一个 dep</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 当前 dep 不包含 activeEffect 则添加到 dep 中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 当前的dep 收集到activeEffect.deps 中</span>
      activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> activeEffect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        activeEffect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          effect<span class="token operator">:</span> activeEffect<span class="token punctuation">,</span>
          target<span class="token punctuation">,</span>
          type<span class="token punctuation">,</span>
          key
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>上面代码可以看到的信息：</p> <ul><li><p>属性被访问时，会执行 <code>track</code> 方法做事件收集工作</p></li> <li><p><code>activeEffect</code> 是一个全局属性，记录当前正被执行的 <code>effect</code>, 其实这个 <code>effect</code> 对应 vue2.0 中的 <code>Watcher</code></p></li> <li><p>每个代理对象都通过 <code>WeakMap</code> 结构保存着这个对象的 收集器集合 <code>depsMap</code></p></li> <li><p>每个对象的属性再通过一步中的 <code>depsMap</code> 保存着对应的 <code>dep</code>， <code>depsMap</code> 是一个 <code>Map</code> 结构</p></li></ul> <p>以上就完成的事件收集的工作</p> <h3 id="触发更新"><a href="#触发更新" class="header-anchor">#</a> 触发更新</h3> <p>当更新响应的数据时，将被 <code>set</code> 方法劫持, 执行 <code>set</code> 中的 <code>trigger</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span> <span class="token comment">/* SET */</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过对象获取当前 收集器集合 depMap</span>
    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果没有，说明对象没有添加响应机制</span>
      <span class="token comment">// never been tracked</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存当前收集到且要执行的 effect </span>
    <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effectsToAdd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将收集到的 effect 添加到 effects 集合中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> effect<span class="token punctuation">.</span>allowRecurse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 略</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&quot;clear&quot;</span> <span class="token comment">/* CLEAR */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// collection being cleared</span>
      <span class="token comment">// trigger all effects for target</span>
      depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 略</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">||</span> key <span class="token operator">&gt;=</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 改变属性时，将执行下面语句</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据 key 获取收集到的 dep 然后执行 add 方法</span>
        <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// also run for iteration key on ADD | DELETE | Map.SET</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;add&quot;</span> <span class="token comment">/* ADD */</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// new index added to array -&gt; length changes</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'length'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;delete&quot;</span> <span class="token comment">/* DELETE */</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;set&quot;</span> <span class="token comment">/* SET */</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          effect<span class="token punctuation">,</span>
          target<span class="token punctuation">,</span>
          key<span class="token punctuation">,</span>
          type<span class="token punctuation">,</span>
          newValue<span class="token punctuation">,</span>
          oldValue<span class="token punctuation">,</span>
          oldTarget
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行每个 effects 的scheduler 方法</span>
        effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历 effects 执行 run 方法</span>
    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>effect.options.scheduler</code> 就是下面的 <code>queueJob</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">queueJob</span><span class="token punctuation">(</span><span class="token parameter">job</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span>length <span class="token operator">||</span>
      <span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> isFlushing <span class="token operator">&amp;&amp;</span> job<span class="token punctuation">.</span>allowRecurse <span class="token operator">?</span> flushIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> flushIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      job <span class="token operator">!==</span> currentPreFlushParentJob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">queueFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>queueJob</code> 方法就是将当前 <code>job(effect)</code> 添加到 <code>queue</code> 队列中，然后执行 <code>queueFlush</code> 方法开始一次微任务的添加，这样在事件循环处理事件队列时就可以执行 <code>effect</code> 方法，具体执行的代码为：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">queueFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFlushing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isFlushPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isFlushPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      currentFlushPromise <span class="token operator">=</span> resolvedPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushJobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">flushJobs</span><span class="token punctuation">(</span><span class="token parameter">seen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isFlushPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    isFlushing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
      seen <span class="token operator">=</span> seen <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">flushPreFlushCbs</span><span class="token punctuation">(</span>seen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对收集到的 effect 进行排序</span>
    queue<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getId</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getId</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>flushIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> flushIndex <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> flushIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> job <span class="token operator">=</span> queue<span class="token punctuation">[</span>flushIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkRecursiveUpdates</span><span class="token punctuation">(</span>seen<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 调用 callWithErrorHandling 执行每一个 effect</span>
          <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">14</span> <span class="token comment">/* SCHEDULER */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      flushIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      queue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">flushPostFlushCbs</span><span class="token punctuation">(</span>seen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isFlushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      currentFlushPromise <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// some postFlushCb queued jobs!</span>
      <span class="token comment">// keep flushing until it drains.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">||</span> pendingPostFlushCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">flushJobs</span><span class="token punctuation">(</span>seen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token comment">// 通过 callWithErrorHandling 执行每个 effect</span>
  <span class="token keyword">function</span> <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> type<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行每一个 effect 方法</span>
      res <span class="token operator">=</span> args <span class="token operator">?</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>更新依赖的过程总结如下：</p> <ol><li><p>属性变更时，触发 <code>trigger</code> 方法，注意这个时间的 <code>type=set</code></p></li> <li><p>从 <code>depsMap</code> 取出当前属性收集的 <code>effect</code> 集合</p></li> <li><p>遍历这些 <code>effect</code> ,执行每个 <code>effect.options.scheduler(effect)</code> 方法，将 <code>efftct</code> 添加到 <code>queue</code> 中</p></li> <li><p>同时添加一个微任务到队列当中</p></li> <li><p>执行微任务时，对 <code>queue</code> 中的 <code>effect</code> 进行排序，然后分别执行 <code>effect</code> 方法</p></li></ol> <h2 id="关于深度对象的监听"><a href="#关于深度对象的监听" class="header-anchor">#</a> 关于深度对象的监听</h2> <div class="language-html extra-class"><pre class="language-html"><code>Counter: {{ counter.cou }}
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      counter<span class="token operator">:</span> <span class="token punctuation">{</span>
        cou<span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>此时的处理步骤为：</p> <ul><li><p>首先仍然会通过 <code>resolveData(instance, dataOptions, publicThis) =&gt;reactive(data) =&gt; createReactiveObject</code>, 给当前 <code>data</code> 的值做 <code>proxy</code> 代理</p></li> <li><p>渲染组件访问 <code>data</code> 对象中的 <code>counter</code> 的属性，调用 <code>track(target, &quot;get&quot; /* GET */, key)</code>,给当前属性 <code>counter</code> 添加事件 <code>effect</code></p></li> <li><p>如果判断到 <code>counter</code> 属性的值是个对象，执行 <code>isReadonly ? readonly(res) : reactive(res)</code>,相当于回到第一步，给当前 <code>counter</code> 值做 <code>proxy</code> 代理</p></li> <li><p>之后访问 <code>counter</code> 对象中访问 <code>cou</code> 的属性，又被 <code>get</code> 劫持,调用 <code>track(target, &quot;get&quot; /* GET */, key)</code>,给当前属性 <code>cou</code> 添加事件 <code>effect</code></p></li></ul> <p><strong>可以看到对于深层的对象，仍然是需要对子对象做代理的，跟 vue2.0 一样，只是设置的代理的时机不同了</strong></p> <ul><li><p>vue2.0 是初始化组件的时候遍历 <code>data</code> 及子属性对象，添加 <code>Object.defineProperry</code> 代理</p></li> <li><p>vue3.0 只有 <code>data</code> 属性是在一开始的时候做 <code>proxy</code> 代理，之后是触发 <code>get</code> 后，再对子对象添加 <code>proxy</code> 代理</p></li></ul> <p>加个 <code>proxy</code> 粟子理解一下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token punctuation">{</span>b<span class="token operator">:</span> <span class="token number">34</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token comment">//输入 p.a</span>
<span class="token comment">//触发 console.log =&gt; - {a: {b: 34}}</span>
<span class="token comment">//输出 {a: {b: 34}}</span>

<span class="token comment">//输入 p.a.b</span>
<span class="token comment">//触发 console.log =&gt; - {a: {b: 34}}</span>
<span class="token comment">//输出 34</span>
</code></pre></div><p>上面例子说明 <code>prosy</code> 只能代理第一层的属性</p> <h3 id="如果是添加属性呢"><a href="#如果是添加属性呢" class="header-anchor">#</a> 如果是添加属性呢？</h3> <p>假设我们给上面粟子中的 <code>counter</code> 对象在后期添加一个属性，Vue 又是怎么处理的呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span>abc <span class="token operator">=</span> <span class="token number">3</span>
</code></pre></div><p>执行上面的语句时代码运行过程：</p> <p>首先得访问 <code>this.counter</code> 属性，此时也会被 <code>get</code> 方法劫持，并执行 <code>track(target, &quot;get&quot; /* GET */, key);</code> 方法，但因为此时全局环境没有 <code>activeEffect</code> 事件，所以没有执行任何事件收集的动作</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> activeEffect <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后 <code>this.counter.abc = 3</code> 时被 <code>set</code> 方法劫持</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取旧值为 undefined</span>
  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前例子为 3 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRef</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldValue<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 因为之前这个属性，hadKey 为false</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>length
    <span class="token operator">:</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 给 target 添加这个属性</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// hadKey 为 false，所以执行 trigger 方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;add&quot;</span> <span class="token comment">/* ADD */</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span> <span class="token comment">/* SET */</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 注意此时的 type = add</span>
  <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 target 收集器集合</span>
    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// never been tracked</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effectsToAdd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> effect<span class="token punctuation">.</span>allowRecurse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&quot;clear&quot;</span> <span class="token comment">/* CLEAR */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// collection being cleared</span>
      <span class="token comment">// trigger all effects for target</span>
      depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">||</span> key <span class="token operator">&gt;=</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// key 有效</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 但是因为当前 key 是新添加的，所以没有当前属性对应的 dep，我们继续往下走</span>
        <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;add&quot;</span> <span class="token comment">/* ADD */</span><span class="token operator">:</span>
        <span class="token comment">// 当前 type 为 add 所以执行以下语句</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 取出 ITERATE_KEY 收集的 effect，之后的步骤添加到微任务队列触发 effect 事件，进行更新 </span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// new index added to array -&gt; length changes</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'length'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;delete&quot;</span> <span class="token comment">/* DELETE */</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;set&quot;</span> <span class="token comment">/* SET */</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          effect<span class="token punctuation">,</span>
          target<span class="token punctuation">,</span>
          key<span class="token punctuation">,</span>
          type<span class="token punctuation">,</span>
          newValue<span class="token punctuation">,</span>
          oldValue<span class="token punctuation">,</span>
          oldTarget
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>总结一下当给对象添加一个属性时的大致过程：</p> <ol><li><p>首先给当前 <code>target</code> 添加新的属性并赋值</p></li> <li><p>调用<code>trigger(target, &quot;add&quot; /* ADD */, key, value);</code>，从 <code>ITERATE_KEY</code> 中取出 <code>effect</code> 事件加入到队列</p></li></ol> <p><code>ITERATE_KEY</code> 是通过 <code>proxy</code> 劫持 <code>ownKeys</code> 属性添加的事件收集</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;iterate&quot;</span> <span class="token comment">/* ITERATE */</span><span class="token punctuation">,</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'length'</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如果是对象 <code>ITERATE_KEY</code> 属性， 数组的话就添加 <code>length</code> 属性，至少是怎么触发的 <code>ownKeys</code> 方法 没找到位置...</p> <ol start="3"><li>当组件更新的时候就会重新取新增的属性，并给属性添加 <code>effect</code> 事件收集</li></ol> <h2 id="数组类型的更新"><a href="#数组类型的更新" class="header-anchor">#</a> 数组类型的更新</h2> <p>将上面的例子改成数据类型： <code>counter: [1,2,3]</code>，当我们使用 <code>counter.push(4)</code> 时看下代码的运行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 略</span>
  <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> targetIsArray <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 略</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// arrayInstrumentations 方法定义</span>
  <span class="token keyword">const</span> arrayInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token string">'includes'</span><span class="token punctuation">,</span> <span class="token string">'indexOf'</span><span class="token punctuation">,</span> <span class="token string">'lastIndexOf'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    arrayInstrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">track</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span> <span class="token comment">/* GET */</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// we run the method using the original args first (which may be reactive)</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> res <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// if that didn't work, run it again using raw values.</span>
        <span class="token keyword">return</span> <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>toRaw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    arrayInstrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>首先当访问 <code>push</code> 属性时，也会被 <code>proxy</code> 劫持，根据下文中的代码，使用将会执行 <code>return Reflect.get(arrayInstrumentations, key, receiver);</code></p> <p><code>arrayInstrumentations</code> 是重写后的一些数组方法的集合，所以将返回 <code>arrayInstrumentations.push</code> 方法</p> <p>之后执行 <code>push(4)</code> 时， 将执行以下语句</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 实际做的事情是  trackStack.push(false);  给 trackStack 添加一个 false 标识</span>
  <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行真正的 Array.push 方法，此时应该等价于 counter[counter.length = 3] = 4 ，所以在获取属性 `3` 时, 会被 set 劫持</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
</code></pre></div><p>上面代码主要做的事情</p> <ol><li><p>pauseTracking()：实际做的事情是 <code>trackStack.push(false)</code>;  给 <code>trackStack</code> 添加一个 <code>false</code> 标识, 暂停依赖收集，也就意味在此期间执行 <code>track</code> 时，不会去收集依赖</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> activeEffect <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>当执行  <code>const res = method.apply(this, args)</code>， 会被 <code>set</code> 劫持</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前例子 key = 3</span>
    <span class="token comment">// value = 4</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;set&quot;</span> <span class="token comment">/* SET */</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effectsToAdd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> effect<span class="token punctuation">.</span>allowRecurse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&quot;clear&quot;</span> <span class="token comment">/* CLEAR */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// also run for iteration key on ADD | DELETE | Map.SET</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;add&quot;</span> <span class="token comment">/* ADD */</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// new index added to array -&gt; length changes</span>
            <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'length'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>跟之前 <code>set</code> 流程类型类型，之后在 <code>trigger</code> 方法根据 <code>length</code> 取出当前对象收集的 <code>effect</code>，添加到微任务队列中进行视图更新</p> <p>那么使用数组下标更改数组也是同理</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>其实思路还是跟 vue2.0 的差不多</p> <ol><li><p>Vue 在初始化的时候使用 <code>proxy</code> 方法代理，关于收集器两个版本的区别</p> <p>Vue2.0 会为每个属性实例化一个事件收集器 <code>Dep</code></p> <p>Vue3.0 则通过全局变量 <code>const targetMap = new WeakMap();</code> 来做事件收集容器，<code>targetMap</code> 的 <code>key</code> 是代理对象，<code>value</code> 是 <code>depsMap</code>(一个收集事件容器的容器)</p> <p><code>depsMap</code> 是 <code>new Map()</code> 结构，代理对象的每个属性收集的事件将存储在这个 <code>depsMap</code> 中，所以找属性收集的事件时，先根据这个属性所属对象从 <code>targetMap</code> 找  <code>depsMap</code>, 在根据具体属性从 <code>depsMap</code> 找事件</p></li> <li><p>在组件渲染的时候，会生成一个 <code>effect</code> 方法，并将当前 <code>effect</code> 保存到全局 <code>activeEffect</code>中，之后在执行渲染操作的时候会读取 <code>data</code> 的属性， 并被 <code>get</code> 劫持，<code>get</code> 方法中将保存在全局的 <code>activeEffect</code> 收集到 <code>depsMap</code> 中</p></li> <li><p>之后当 <code>data</code> 属性被更改时，会被 <code>set</code> 劫持，从 <code>depsMap</code> 取出 <code>effect</code> 并执行</p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lanjz/Vue3/createApp.html" class="prev">
        createApp
      </a></span> <span class="next"><a href="/lanjz/Vue3/watch.html">
        Watch
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/lanjz/assets/js/app.f0225df9.js" defer></script><script src="/lanjz/assets/js/2.5f61dcad.js" defer></script><script src="/lanjz/assets/js/183.ae7ecd14.js" defer></script>
  </body>
</html>
