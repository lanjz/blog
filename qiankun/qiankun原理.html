<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>qiankun原理 | Hello Wold</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/lanjz/assets/css/0.styles.5dda244b.css" as="style"><link rel="preload" href="/lanjz/assets/js/app.e889b93f.js" as="script"><link rel="preload" href="/lanjz/assets/js/2.30c9612b.js" as="script"><link rel="preload" href="/lanjz/assets/js/197.90a70dd8.js" as="script"><link rel="prefetch" href="/lanjz/assets/js/10.de9ac23f.js"><link rel="prefetch" href="/lanjz/assets/js/100.4e35f4c5.js"><link rel="prefetch" href="/lanjz/assets/js/101.45b4796b.js"><link rel="prefetch" href="/lanjz/assets/js/102.854f637b.js"><link rel="prefetch" href="/lanjz/assets/js/103.fd5f5d88.js"><link rel="prefetch" href="/lanjz/assets/js/104.50ad4313.js"><link rel="prefetch" href="/lanjz/assets/js/105.ab0e47b2.js"><link rel="prefetch" href="/lanjz/assets/js/106.352324cb.js"><link rel="prefetch" href="/lanjz/assets/js/107.9f934f47.js"><link rel="prefetch" href="/lanjz/assets/js/108.bb58a6e5.js"><link rel="prefetch" href="/lanjz/assets/js/109.4c727ab4.js"><link rel="prefetch" href="/lanjz/assets/js/11.66afd1fc.js"><link rel="prefetch" href="/lanjz/assets/js/110.6b28b6b0.js"><link rel="prefetch" href="/lanjz/assets/js/111.e2bab1b2.js"><link rel="prefetch" href="/lanjz/assets/js/112.24aa2c03.js"><link rel="prefetch" href="/lanjz/assets/js/113.7b1c20a1.js"><link rel="prefetch" href="/lanjz/assets/js/114.4d1b08c8.js"><link rel="prefetch" href="/lanjz/assets/js/115.41664515.js"><link rel="prefetch" href="/lanjz/assets/js/116.ab71433d.js"><link rel="prefetch" href="/lanjz/assets/js/117.a80fa270.js"><link rel="prefetch" href="/lanjz/assets/js/118.f616dbb2.js"><link rel="prefetch" href="/lanjz/assets/js/119.c8294f2a.js"><link rel="prefetch" href="/lanjz/assets/js/12.c696265c.js"><link rel="prefetch" href="/lanjz/assets/js/120.8510540d.js"><link rel="prefetch" href="/lanjz/assets/js/121.6adf5de5.js"><link rel="prefetch" href="/lanjz/assets/js/122.0d6fd647.js"><link rel="prefetch" href="/lanjz/assets/js/123.204284e3.js"><link rel="prefetch" href="/lanjz/assets/js/124.ef4ab1cc.js"><link rel="prefetch" href="/lanjz/assets/js/125.d67cec13.js"><link rel="prefetch" href="/lanjz/assets/js/126.da5b6391.js"><link rel="prefetch" href="/lanjz/assets/js/127.1782a99e.js"><link rel="prefetch" href="/lanjz/assets/js/128.b1463c11.js"><link rel="prefetch" href="/lanjz/assets/js/129.a7cdd87b.js"><link rel="prefetch" href="/lanjz/assets/js/13.a85b29b2.js"><link rel="prefetch" href="/lanjz/assets/js/130.f2701c67.js"><link rel="prefetch" href="/lanjz/assets/js/131.041a4f25.js"><link rel="prefetch" href="/lanjz/assets/js/132.1e7eebfa.js"><link rel="prefetch" href="/lanjz/assets/js/133.04f64393.js"><link rel="prefetch" href="/lanjz/assets/js/134.b066bba7.js"><link rel="prefetch" href="/lanjz/assets/js/135.07343f16.js"><link rel="prefetch" href="/lanjz/assets/js/136.020992e4.js"><link rel="prefetch" href="/lanjz/assets/js/137.e4715b43.js"><link rel="prefetch" href="/lanjz/assets/js/138.6dd18765.js"><link rel="prefetch" href="/lanjz/assets/js/139.e02d6a63.js"><link rel="prefetch" href="/lanjz/assets/js/14.bce51efb.js"><link rel="prefetch" href="/lanjz/assets/js/140.463a33bc.js"><link rel="prefetch" href="/lanjz/assets/js/141.923c043b.js"><link rel="prefetch" href="/lanjz/assets/js/142.c9840a6f.js"><link rel="prefetch" href="/lanjz/assets/js/143.6b8161c6.js"><link rel="prefetch" href="/lanjz/assets/js/144.f292864d.js"><link rel="prefetch" href="/lanjz/assets/js/145.19e85b7a.js"><link rel="prefetch" href="/lanjz/assets/js/146.0d476036.js"><link rel="prefetch" href="/lanjz/assets/js/147.c39b62e4.js"><link rel="prefetch" href="/lanjz/assets/js/148.1371a22e.js"><link rel="prefetch" href="/lanjz/assets/js/149.47f6b421.js"><link rel="prefetch" href="/lanjz/assets/js/15.301639fa.js"><link rel="prefetch" href="/lanjz/assets/js/150.b2b49eb8.js"><link rel="prefetch" href="/lanjz/assets/js/151.4c7f1864.js"><link rel="prefetch" href="/lanjz/assets/js/152.c24428c3.js"><link rel="prefetch" href="/lanjz/assets/js/153.d6b7ec7d.js"><link rel="prefetch" href="/lanjz/assets/js/154.0bd6db87.js"><link rel="prefetch" href="/lanjz/assets/js/155.d89860ba.js"><link rel="prefetch" href="/lanjz/assets/js/156.9e36aa2c.js"><link rel="prefetch" href="/lanjz/assets/js/157.1cf120b5.js"><link rel="prefetch" href="/lanjz/assets/js/158.386a3a1b.js"><link rel="prefetch" href="/lanjz/assets/js/159.e81e6f99.js"><link rel="prefetch" href="/lanjz/assets/js/16.f4cfeed1.js"><link rel="prefetch" href="/lanjz/assets/js/160.c079f1d4.js"><link rel="prefetch" href="/lanjz/assets/js/161.63b717c5.js"><link rel="prefetch" href="/lanjz/assets/js/162.ee79ad24.js"><link rel="prefetch" href="/lanjz/assets/js/163.0f169c91.js"><link rel="prefetch" href="/lanjz/assets/js/164.9afb2729.js"><link rel="prefetch" href="/lanjz/assets/js/165.97d334bc.js"><link rel="prefetch" href="/lanjz/assets/js/166.f39fe304.js"><link rel="prefetch" href="/lanjz/assets/js/167.164420f7.js"><link rel="prefetch" href="/lanjz/assets/js/168.12f46eca.js"><link rel="prefetch" href="/lanjz/assets/js/169.437a8dfa.js"><link rel="prefetch" href="/lanjz/assets/js/17.a4b3436c.js"><link rel="prefetch" href="/lanjz/assets/js/170.da9d8fce.js"><link rel="prefetch" href="/lanjz/assets/js/171.79f81edf.js"><link rel="prefetch" href="/lanjz/assets/js/172.a82dcf80.js"><link rel="prefetch" href="/lanjz/assets/js/173.4f01600b.js"><link rel="prefetch" href="/lanjz/assets/js/174.f06577e8.js"><link rel="prefetch" href="/lanjz/assets/js/175.82a1be2a.js"><link rel="prefetch" href="/lanjz/assets/js/176.8a814f9a.js"><link rel="prefetch" href="/lanjz/assets/js/177.82929e79.js"><link rel="prefetch" href="/lanjz/assets/js/178.7eb42f3f.js"><link rel="prefetch" href="/lanjz/assets/js/179.e67d78c9.js"><link rel="prefetch" href="/lanjz/assets/js/18.0f9bab3d.js"><link rel="prefetch" href="/lanjz/assets/js/180.8904c601.js"><link rel="prefetch" href="/lanjz/assets/js/181.8767416c.js"><link rel="prefetch" href="/lanjz/assets/js/182.1ccf1e4c.js"><link rel="prefetch" href="/lanjz/assets/js/183.fb1660fa.js"><link rel="prefetch" href="/lanjz/assets/js/184.cca16cf5.js"><link rel="prefetch" href="/lanjz/assets/js/185.41d279d6.js"><link rel="prefetch" href="/lanjz/assets/js/186.d1d2cbe1.js"><link rel="prefetch" href="/lanjz/assets/js/187.7c0a6fbd.js"><link rel="prefetch" href="/lanjz/assets/js/188.7a9c15dc.js"><link rel="prefetch" href="/lanjz/assets/js/189.8735963e.js"><link rel="prefetch" href="/lanjz/assets/js/19.1b26e5ec.js"><link rel="prefetch" href="/lanjz/assets/js/190.ded7237d.js"><link rel="prefetch" href="/lanjz/assets/js/191.c6825143.js"><link rel="prefetch" href="/lanjz/assets/js/192.36f885f8.js"><link rel="prefetch" href="/lanjz/assets/js/193.434e54b1.js"><link rel="prefetch" href="/lanjz/assets/js/194.d2736de9.js"><link rel="prefetch" href="/lanjz/assets/js/195.f1e4cee3.js"><link rel="prefetch" href="/lanjz/assets/js/196.c9d242b9.js"><link rel="prefetch" href="/lanjz/assets/js/198.986fa9e5.js"><link rel="prefetch" href="/lanjz/assets/js/199.f6e8cd62.js"><link rel="prefetch" href="/lanjz/assets/js/20.2996c893.js"><link rel="prefetch" href="/lanjz/assets/js/200.2b2d2eff.js"><link rel="prefetch" href="/lanjz/assets/js/201.90f9d9e7.js"><link rel="prefetch" href="/lanjz/assets/js/202.781e775e.js"><link rel="prefetch" href="/lanjz/assets/js/203.4f7b9381.js"><link rel="prefetch" href="/lanjz/assets/js/204.14d1415d.js"><link rel="prefetch" href="/lanjz/assets/js/205.a8ef77d5.js"><link rel="prefetch" href="/lanjz/assets/js/206.cecdcb0d.js"><link rel="prefetch" href="/lanjz/assets/js/207.30009dab.js"><link rel="prefetch" href="/lanjz/assets/js/208.a9e5c013.js"><link rel="prefetch" href="/lanjz/assets/js/209.ba850d54.js"><link rel="prefetch" href="/lanjz/assets/js/21.1fb96bb1.js"><link rel="prefetch" href="/lanjz/assets/js/210.9f99d6de.js"><link rel="prefetch" href="/lanjz/assets/js/211.74f6aef4.js"><link rel="prefetch" href="/lanjz/assets/js/212.c03ef1e5.js"><link rel="prefetch" href="/lanjz/assets/js/22.29edc1d3.js"><link rel="prefetch" href="/lanjz/assets/js/23.9064ebc5.js"><link rel="prefetch" href="/lanjz/assets/js/24.bd632e3d.js"><link rel="prefetch" href="/lanjz/assets/js/25.11a57cef.js"><link rel="prefetch" href="/lanjz/assets/js/26.3b1c9fc0.js"><link rel="prefetch" href="/lanjz/assets/js/27.0b74e252.js"><link rel="prefetch" href="/lanjz/assets/js/28.ce356e2f.js"><link rel="prefetch" href="/lanjz/assets/js/29.809ea4a5.js"><link rel="prefetch" href="/lanjz/assets/js/3.f58818d1.js"><link rel="prefetch" href="/lanjz/assets/js/30.0c7b8bfd.js"><link rel="prefetch" href="/lanjz/assets/js/31.40eabd5c.js"><link rel="prefetch" href="/lanjz/assets/js/32.6c70da89.js"><link rel="prefetch" href="/lanjz/assets/js/33.cab03b59.js"><link rel="prefetch" href="/lanjz/assets/js/34.3db6323e.js"><link rel="prefetch" href="/lanjz/assets/js/35.6afe70c6.js"><link rel="prefetch" href="/lanjz/assets/js/36.fa682bb0.js"><link rel="prefetch" href="/lanjz/assets/js/37.14e22fc7.js"><link rel="prefetch" href="/lanjz/assets/js/38.f6e37055.js"><link rel="prefetch" href="/lanjz/assets/js/39.57cf63c3.js"><link rel="prefetch" href="/lanjz/assets/js/4.9615b643.js"><link rel="prefetch" href="/lanjz/assets/js/40.4a1e407a.js"><link rel="prefetch" href="/lanjz/assets/js/41.aa3e770a.js"><link rel="prefetch" href="/lanjz/assets/js/42.a2d69dbc.js"><link rel="prefetch" href="/lanjz/assets/js/43.f3336fa1.js"><link rel="prefetch" href="/lanjz/assets/js/44.64cba701.js"><link rel="prefetch" href="/lanjz/assets/js/45.502a03d7.js"><link rel="prefetch" href="/lanjz/assets/js/46.900d0131.js"><link rel="prefetch" href="/lanjz/assets/js/47.2599a969.js"><link rel="prefetch" href="/lanjz/assets/js/48.cc486645.js"><link rel="prefetch" href="/lanjz/assets/js/49.0090d76f.js"><link rel="prefetch" href="/lanjz/assets/js/5.1b9a30f9.js"><link rel="prefetch" href="/lanjz/assets/js/50.bd96bad0.js"><link rel="prefetch" href="/lanjz/assets/js/51.a1e5aa35.js"><link rel="prefetch" href="/lanjz/assets/js/52.2969e098.js"><link rel="prefetch" href="/lanjz/assets/js/53.98928f65.js"><link rel="prefetch" href="/lanjz/assets/js/54.2cb44d02.js"><link rel="prefetch" href="/lanjz/assets/js/55.046c30d5.js"><link rel="prefetch" href="/lanjz/assets/js/56.1b096eae.js"><link rel="prefetch" href="/lanjz/assets/js/57.7276ce3d.js"><link rel="prefetch" href="/lanjz/assets/js/58.d86f8e5c.js"><link rel="prefetch" href="/lanjz/assets/js/59.a3c85371.js"><link rel="prefetch" href="/lanjz/assets/js/6.b5ed71e8.js"><link rel="prefetch" href="/lanjz/assets/js/60.abe1c6f7.js"><link rel="prefetch" href="/lanjz/assets/js/61.6202e2d8.js"><link rel="prefetch" href="/lanjz/assets/js/62.edc87a05.js"><link rel="prefetch" href="/lanjz/assets/js/63.dd6518fc.js"><link rel="prefetch" href="/lanjz/assets/js/64.86f1fd70.js"><link rel="prefetch" href="/lanjz/assets/js/65.a7b54608.js"><link rel="prefetch" href="/lanjz/assets/js/66.18153618.js"><link rel="prefetch" href="/lanjz/assets/js/67.3bd0828b.js"><link rel="prefetch" href="/lanjz/assets/js/68.ed199eb7.js"><link rel="prefetch" href="/lanjz/assets/js/69.11cf4bf3.js"><link rel="prefetch" href="/lanjz/assets/js/7.6fafab4c.js"><link rel="prefetch" href="/lanjz/assets/js/70.d7411b7b.js"><link rel="prefetch" href="/lanjz/assets/js/71.7098b0d3.js"><link rel="prefetch" href="/lanjz/assets/js/72.a1063990.js"><link rel="prefetch" href="/lanjz/assets/js/73.2f90718b.js"><link rel="prefetch" href="/lanjz/assets/js/74.48c9d693.js"><link rel="prefetch" href="/lanjz/assets/js/75.c60cea8c.js"><link rel="prefetch" href="/lanjz/assets/js/76.ea57e27d.js"><link rel="prefetch" href="/lanjz/assets/js/77.ec9e6171.js"><link rel="prefetch" href="/lanjz/assets/js/78.99bd3385.js"><link rel="prefetch" href="/lanjz/assets/js/79.a493ccc0.js"><link rel="prefetch" href="/lanjz/assets/js/8.d4016234.js"><link rel="prefetch" href="/lanjz/assets/js/80.526f070b.js"><link rel="prefetch" href="/lanjz/assets/js/81.4d49acaa.js"><link rel="prefetch" href="/lanjz/assets/js/82.9565685e.js"><link rel="prefetch" href="/lanjz/assets/js/83.3363a629.js"><link rel="prefetch" href="/lanjz/assets/js/84.1b2fae0e.js"><link rel="prefetch" href="/lanjz/assets/js/85.91dd4cf9.js"><link rel="prefetch" href="/lanjz/assets/js/86.928e7c4a.js"><link rel="prefetch" href="/lanjz/assets/js/87.054f56b3.js"><link rel="prefetch" href="/lanjz/assets/js/88.0213a077.js"><link rel="prefetch" href="/lanjz/assets/js/89.f85cf355.js"><link rel="prefetch" href="/lanjz/assets/js/9.71c8a646.js"><link rel="prefetch" href="/lanjz/assets/js/90.66ee1b7f.js"><link rel="prefetch" href="/lanjz/assets/js/91.36315d64.js"><link rel="prefetch" href="/lanjz/assets/js/92.057ba58b.js"><link rel="prefetch" href="/lanjz/assets/js/93.f237933d.js"><link rel="prefetch" href="/lanjz/assets/js/94.21db5be7.js"><link rel="prefetch" href="/lanjz/assets/js/95.c52d541a.js"><link rel="prefetch" href="/lanjz/assets/js/96.37be205e.js"><link rel="prefetch" href="/lanjz/assets/js/97.8755f8f3.js"><link rel="prefetch" href="/lanjz/assets/js/98.c132f270.js"><link rel="prefetch" href="/lanjz/assets/js/99.e945fd40.js">
    <link rel="stylesheet" href="/lanjz/assets/css/0.styles.5dda244b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lanjz/" class="home-link router-link-active"><!----> <span class="site-name">Hello Wold</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lanjz/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/HTML5/" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/CSS/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Browser/" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络&amp;算法" class="dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络&amp;算法" class="mobile-dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/secure/" class="nav-link">
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Vue3/" class="nav-link">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/qiankun/" class="nav-link router-link-active">
  qiankun
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/NA/" class="nav-link">
  跨平台
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Node/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Api/" class="nav-link">
  API
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Package/" class="nav-link">
  yarn&amp;npm
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/数据库/" class="nav-link">
  SQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端优化总结/" class="nav-link">
  前端优化总结
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/系统设计/" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/预加载&amp;预解析.html" class="nav-link">
  预加载&amp;预解析
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/重构改善既有代码的设计.html" class="nav-link">
  重构代码原则
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/开发与调试技巧.html" class="nav-link">
  开发与调试
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/组件设计的基本原则.html" class="nav-link">
  组件设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/公共模块管理.html" class="nav-link">
  公共模块管理
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/内存泄漏.html" class="nav-link">
  内存泄漏
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端异常捕获.html" class="nav-link">
  前端异常捕获
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/自动化部署.html" class="nav-link">
  自动化部署
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/疑难杂症.html" class="nav-link">
  问题小计
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="利其器" class="dropdown-title"><span class="title">利其器</span> <span class="arrow down"></span></button> <button type="button" aria-label="利其器" class="mobile-dropdown-title"><span class="title">利其器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Mac.html" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Github.html" class="nav-link">
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/lanjz/Im/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lanjz/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/HTML5/" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/CSS/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Browser/" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络&amp;算法" class="dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络&amp;算法" class="mobile-dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/secure/" class="nav-link">
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Vue3/" class="nav-link">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/qiankun/" class="nav-link router-link-active">
  qiankun
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/NA/" class="nav-link">
  跨平台
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Node/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Api/" class="nav-link">
  API
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Package/" class="nav-link">
  yarn&amp;npm
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/数据库/" class="nav-link">
  SQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端优化总结/" class="nav-link">
  前端优化总结
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/系统设计/" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/预加载&amp;预解析.html" class="nav-link">
  预加载&amp;预解析
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/重构改善既有代码的设计.html" class="nav-link">
  重构代码原则
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/开发与调试技巧.html" class="nav-link">
  开发与调试
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/组件设计的基本原则.html" class="nav-link">
  组件设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/公共模块管理.html" class="nav-link">
  公共模块管理
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/内存泄漏.html" class="nav-link">
  内存泄漏
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端异常捕获.html" class="nav-link">
  前端异常捕获
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/自动化部署.html" class="nav-link">
  自动化部署
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/疑难杂症.html" class="nav-link">
  问题小计
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="利其器" class="dropdown-title"><span class="title">利其器</span> <span class="arrow down"></span></button> <button type="button" aria-label="利其器" class="mobile-dropdown-title"><span class="title">利其器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Mac.html" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Github.html" class="nav-link">
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/lanjz/Im/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/lanjz/qiankun/微前端.html" class="sidebar-link">微前端</a></li><li><a href="/lanjz/qiankun/qiankun原理.html" class="active sidebar-link">qiankun原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#子应用加载过程" class="sidebar-link">子应用加载过程</a></li><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#子应用沙箱" class="sidebar-link">子应用沙箱</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#proxysandbox" class="sidebar-link">ProxySandbox</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#关于动态创建的样式和脚本" class="sidebar-link">关于动态创建的样式和脚本</a></li><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#样式隔离" class="sidebar-link">样式隔离</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#strictstyleisolation" class="sidebar-link">strictStyleIsolation</a></li><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#scopedcss" class="sidebar-link">scopedCSS</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#应用通信" class="sidebar-link">应用通信</a></li><li class="sidebar-sub-header"><a href="/lanjz/qiankun/qiankun原理.html#预加载" class="sidebar-link">预加载</a></li></ul></li><li><a href="/lanjz/qiankun/importHtmlEntry.html" class="sidebar-link">import-html-entry</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="qiankun原理"><a href="#qiankun原理" class="header-anchor">#</a> qiankun原理</h1> <p>之前大致了玩了下 qiankun 框架的使用，现在开始了解一下它的实现原理，但是稍微看了下源码后，发现源码太多回调了看得实现是晕，所以不细读源码了，直接带些问题去找下对应的实现原理</p> <h2 id="子应用加载过程"><a href="#子应用加载过程" class="header-anchor">#</a> 子应用加载过程</h2> <p>子应用路由激活时，将执行 <code>loadApp</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> loadApp<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectType</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  app<span class="token operator">:</span> LoadableApp<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  configuration<span class="token operator">:</span> FrameworkConfiguration <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  lifeCycles<span class="token operator">?</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>ParcelConfigObjectGetter<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// entry 子应用链接; name:app名字</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> name<span class="token operator">:</span> appName <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token keyword">const</span> appInstanceId <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> markName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] App </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appInstanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> Loading</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> singular <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> sandbox <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">,</span> <span class="token operator">...</span>importEntryOpts <span class="token punctuation">}</span> <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
  <span class="token comment">// 通过 importEntry 获取子应用内容</span>
  <span class="token comment">// template 内容+样式; execScripts 要执行的js; assetPublicPath 子应用host</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> template<span class="token punctuation">,</span> execScripts<span class="token punctuation">,</span> assetPublicPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">importEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否单例应用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  	<span class="token comment">// 是的话等之有应用卸载后再加载当前应用</span>
    <span class="token keyword">await</span> <span class="token punctuation">(</span>prevAppUnmountedDeferred <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 添加一个div元素包装 子应用内容 </span>
  <span class="token keyword">const</span> appContent <span class="token operator">=</span> <span class="token function">getDefaultTplWrapper</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> strictStyleIsolation <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>strictStyleIsolation<span class="token punctuation">;</span>
  <span class="token keyword">const</span> scopedCSS <span class="token operator">=</span> <span class="token function">isEnableScopedCSS</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据样式隔离配置，对子应用的样式做下处理</span>
  <span class="token keyword">let</span> initialAppWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
    appContent<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> initialContainer <span class="token operator">=</span> <span class="token string">'container'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>container <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> legacyRender <span class="token operator">=</span> <span class="token string">'render'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>render <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 开始将子应用内容添加到 DOM中</span>
  <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">getRender</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> appContent<span class="token punctuation">,</span> legacyRender<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 第一次加载设置应用可见区域 dom 结构</span>
  <span class="token comment">// 确保每次应用加载前容器 dom 结构已经设置完毕</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> element<span class="token operator">:</span> initialAppWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> initialContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> initialAppWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
    appName<span class="token punctuation">,</span>
    appInstanceId<span class="token punctuation">,</span>
    <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> initialAppWrapperElement<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> global <span class="token operator">=</span> window<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">mountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">unmountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> useLooseSandbox <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>loose<span class="token punctuation">;</span>
  <span class="token keyword">let</span> sandboxContainer<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建JS运行环境沙箱</span>
    sandboxContainer <span class="token operator">=</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
      appName<span class="token punctuation">,</span>
      <span class="token comment">// FIXME should use a strict sandbox logic while remount, see https://github.com/umijs/qiankun/issues/518</span>
      initialAppWrapperGetter<span class="token punctuation">,</span>
      scopedCSS<span class="token punctuation">,</span>
      useLooseSandbox<span class="token punctuation">,</span>
      excludeAssetFilter<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用沙箱的代理对象作为接下来使用的全局对象</span>
    global <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>proxy <span class="token keyword">as</span> <span class="token keyword">typeof</span> window<span class="token punctuation">;</span>
    mountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>mount<span class="token punctuation">;</span>
    unmountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>unmount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取钩子</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> beforeUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> afterUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> afterMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> beforeMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> beforeLoad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">mergeWith</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">getAddOns</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> assetPublicPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
    lifeCycles<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">concat</span><span class="token punctuation">(</span>v1 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行 beforeLoad 钩子</span>
  <span class="token keyword">await</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeLoad<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// get the lifecycle hooks from module exports</span>
  <span class="token comment">// 执行子应用JS代码</span>
  <span class="token keyword">const</span> scriptExports<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execScripts</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token operator">!</span>useLooseSandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取钩子</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> bootstrap<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> unmount<span class="token punctuation">,</span> update <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getLifecyclesFromExports</span><span class="token punctuation">(</span>
    scriptExports<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
    global<span class="token punctuation">,</span>
    sandboxContainer<span class="token operator">?.</span>instance<span class="token operator">?.</span>latestSetProp<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 通信配置</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    onGlobalStateChange<span class="token punctuation">,</span>
    setGlobalState<span class="token punctuation">,</span>
    offGlobalStateChange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> CallableFunction<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">getMicroAppStateActions</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// FIXME temporary way</span>
  <span class="token keyword">const</span> <span class="token function-variable function">syncAppWrapperElement2Sandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>initialAppWrapperElement <span class="token operator">=</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> parcelConfigGetter<span class="token operator">:</span> <span class="token function-variable function">ParcelConfigObjectGetter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">remountContainer <span class="token operator">=</span> initialContainer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> appWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> initialAppWrapperElement<span class="token punctuation">;</span>
    <span class="token keyword">const</span> appWrapperGetter <span class="token operator">=</span> <span class="token function">getAppWrapperGetter</span><span class="token punctuation">(</span>
      appName<span class="token punctuation">,</span>
      appInstanceId<span class="token punctuation">,</span>
      <span class="token operator">!</span><span class="token operator">!</span>legacyRender<span class="token punctuation">,</span>
      strictStyleIsolation<span class="token punctuation">,</span>
      scopedCSS<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> appWrapperElement<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> parcelConfig<span class="token operator">:</span> ParcelConfigObject <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> appInstanceId<span class="token punctuation">,</span>
      bootstrap<span class="token punctuation">,</span>
      mount<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      unmount<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      parcelConfig<span class="token punctuation">.</span>update <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> parcelConfig<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> parcelConfigGetter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>直接挑几个重点部分看一下</p> <p><strong>加载子应用内容</strong></p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> <span class="token punctuation">{</span> template<span class="token punctuation">,</span> execScripts<span class="token punctuation">,</span> assetPublicPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">importEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 <code>importEntry</code> 是 <code>import-html-entry</code> 库提供的方法，用于加载子应用的资源，关于 <code>import-html-entry</code> 会有单独的一单来讲解，这里先大致介绍下 <code>importEntry</code> 返回的三个属性的意思：</p> <ul><li><p><code>embedHTML</code>： html 内容，如果包含 <code>link</code> 样式资源的标签，将会把这些样式转换成内联样式直接包含在 html 内容中</p></li> <li><p><code>assetPublicPath</code>: 子应用加载域名</p></li> <li><p><code>execScripts</code>: 执行JS代码的方法，如果执行的JS是入口文件的话，返回最后一个设置的全局变量，这个所谓的最后一个设置的全局变量在这里指的就是我们在子应用导出的 <code>bootstrap</code>、 <code>mount</code> 、 <code>unmount</code> 三个方法</p></li></ul> <p><strong>go on</strong></p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">validateSingularMode</span><span class="token punctuation">(</span>singular<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">await</span> <span class="token punctuation">(</span>prevAppUnmountedDeferred <span class="token operator">&amp;&amp;</span> prevAppUnmountedDeferred<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>判断是否是单例应用，是单例应用的话则等到之前的应用卸载完成后再继续往下走</p> <p><strong>包装子应用内容</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> appContent <span class="token operator">=</span> <span class="token function">getDefaultTplWrapper</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// getDefaultTplWrapper</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getDefaultTplWrapper</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> string<span class="token punctuation">,</span> name<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">tpl<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div id=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getWrapperId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; data-name=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tpl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 <code>getDefaultTplWrapper</code> 给 <code>importEntry</code> 返回的 <code>template</code> 内容包一层 <code>div</code>，这个 <code>div</code> 包含一些 <code>qiankun</code> 定义的标志属性</p> <p><strong>样式隔离</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> strictStyleIsolation <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>strictStyleIsolation<span class="token punctuation">;</span>
  <span class="token keyword">const</span> scopedCSS <span class="token operator">=</span> <span class="token function">isEnableScopedCSS</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> initialAppWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
    appContent<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>先是获取样式隔离规则，调用 <code>createElement</code> 方法根据规则处理当前页面内容，样式隔离的实现大体分两种 <code>strictStyleIsolation</code> 和 <code>scopedCSS</code></p> <ul><li><p>strictStyleIsolation：每个微应用的容器包裹上一个 shadow dom 节点</p></li> <li><p>scopedCSS：qiankun 会改写子应用所添加的样式为所有样式规则增加一个特殊的选择器规则来限定其影响范围</p></li></ul> <p><strong>挂载子应用内容</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> initialContainer <span class="token operator">=</span> <span class="token string">'container'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>container <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> legacyRender <span class="token operator">=</span> <span class="token string">'render'</span> <span class="token keyword">in</span> app <span class="token operator">?</span> app<span class="token punctuation">.</span>render <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">getRender</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> appContent<span class="token punctuation">,</span> legacyRender<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> element<span class="token operator">:</span> initialAppWrapperElement<span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> container<span class="token operator">:</span> initialContainer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// getRender</span>
<span class="token keyword">function</span> <span class="token function">getRender</span><span class="token punctuation">(</span><span class="token parameter">appName<span class="token operator">:</span> string<span class="token punctuation">,</span> appContent<span class="token operator">:</span> string<span class="token punctuation">,</span> legacyRender<span class="token operator">?</span><span class="token operator">:</span> HTMLContentRender</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> render<span class="token operator">:</span> <span class="token function-variable function">ElementRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> element<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> container <span class="token punctuation">}</span><span class="token punctuation">,</span> phase</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>legacyRender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">legacyRender</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading<span class="token punctuation">,</span> appContent<span class="token operator">:</span> element <span class="token operator">?</span> appContent <span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> containerElement <span class="token operator">=</span> <span class="token function">getContainer</span><span class="token punctuation">(</span>container<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">!==</span> <span class="token string">'unmounted'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errorMsg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>phase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'loading'</span><span class="token operator">:</span>
          <span class="token keyword">case</span> <span class="token string">'mounting'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] Target container with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not existed while </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'mounted'</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] Target container with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not existed after </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

          <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] Target container with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not existed while </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> rendering!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assertElementExist</span><span class="token punctuation">(</span>containerElement<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>containerElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>containerElement<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// clear the container</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>containerElement<span class="token operator">!</span><span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">rawRemoveChild</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>containerElement<span class="token punctuation">,</span> containerElement<span class="token operator">!</span><span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// append the element to container if it exist</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">rawAppendChild</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>containerElement<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> render<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>getRender</code> 获取 <code>render</code> 方法并执行</p> <p><code>getContainer(container)</code> 获取子应用要挂载的 DOM 元素，如果挂载 DOM 元素有内容则清空内容，之后就是将我们的子应用添加到挂载 DOM 中去，这一步正常的话容器中将出现我们子应用内容了，但还没有运行子应用中的JS代码</p> <p><strong>创建子应用运行环境沙箱</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> global <span class="token operator">=</span> window<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">mountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">unmountSandbox</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> useLooseSandbox <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>loose<span class="token punctuation">;</span>
  <span class="token keyword">let</span> sandboxContainer<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sandboxContainer <span class="token operator">=</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
      appName<span class="token punctuation">,</span>
      <span class="token comment">// FIXME should use a strict sandbox logic while remount, see https://github.com/umijs/qiankun/issues/518</span>
      initialAppWrapperGetter<span class="token punctuation">,</span>
      scopedCSS<span class="token punctuation">,</span>
      useLooseSandbox<span class="token punctuation">,</span>
      excludeAssetFilter<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用沙箱的代理对象作为接下来使用的全局对象</span>
    global <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>proxy <span class="token keyword">as</span> <span class="token keyword">typeof</span> window<span class="token punctuation">;</span>
    mountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>mount<span class="token punctuation">;</span>
    unmountSandbox <span class="token operator">=</span> sandboxContainer<span class="token punctuation">.</span>unmount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>沙箱的作用就是保证子应用之间状态能独立运行，不会造成全局污染和相互影响，上面代码通过 <code>createSandboxContainer</code> 方法创建一个沙箱，这里返回的 <code>sandboxContainer</code> 对象将包含一个 <code>proxy</code> 的属性，这个 <code>sandboxContainer.instance.proxy</code> 将是子应用的全局运行的环境，也就是子应用的对于全局环境 <code>window</code> 的任何操作，也被代理到这个 <code>proxy</code> 对象上，以此来达到环境隔离的作用。具体沙箱的实现方式下文再细讲，这里先继续往下走</p> <p>除了代理全局对象外 <code>sandboxContainer</code> 还暴露出来 <code>mount</code>，<code>unmount</code> 方法，等执行到这里再看他们的作用</p> <p><strong>执行beforeLoad钩子函数</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> beforeUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> afterUnmount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> afterMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> beforeMount <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> beforeLoad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">mergeWith</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">getAddOns</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> assetPublicPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
    lifeCycles<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">concat</span><span class="token punctuation">(</span>v1 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2 <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token function">execHooksChain</span><span class="token punctuation">(</span><span class="token function">toArray</span><span class="token punctuation">(</span>beforeLoad<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>取出要执行的 <code>beforeLoad</code> 钩子方法，以下找到的要执行的钩子的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// addons/engineFlag</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getAddOn</span><span class="token punctuation">(</span><span class="token parameter">global<span class="token operator">:</span> Window</span><span class="token punctuation">)</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">beforeLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      global<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      global<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> global<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getAddOn</span><span class="token punctuation">(</span>global<span class="token operator">:</span> Window<span class="token punctuation">,</span> publicPath <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">:</span> FrameworkLifeCycles<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hasMountedOnce <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">beforeLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__ <span class="token operator">=</span> publicPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">beforeMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasMountedOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__ <span class="token operator">=</span> publicPath<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rawPublicPath <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        global<span class="token punctuation">.</span>__INJECTED_PUBLIC_PATH_BY_QIANKUN__ <span class="token operator">=</span> rawPublicPath<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      hasMountedOnce <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 最后是我们使用 registerMicroApps 定义的钩子 </span>
<span class="token function">registerMicroApps</span><span class="token punctuation">(</span>apps<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">beforeLoad</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;before load&quot;</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>先执行 <code>beforeLoad</code> 钩子, 从上面贴出的代码可以看到内置 <code>beforeLoad</code> 钩子作用就是设置几个全局变量：</p> <ul><li><p><code>global.__POWERED_BY_QIANKUN__ = true</code>，给子应用全局环境设置当前是微应用启动的标识</p></li> <li><p><code>global.__INJECTED_PUBLIC_PATH_BY_QIANKUN__ = publicPath</code>，标识当前子应用启动的根路径</p></li></ul> <p>最后将执行我们设置的钩子</p> <p><strong>执行子应用中的JS</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> scriptExports<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execScripts</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token operator">!</span>useLooseSandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// get the lifecycle hooks from module exports</span>
<span class="token keyword">const</span> scriptExports<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execScripts</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token operator">!</span>useLooseSandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> bootstrap<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> unmount<span class="token punctuation">,</span> update <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getLifecyclesFromExports</span><span class="token punctuation">(</span>
  scriptExports<span class="token punctuation">,</span>
  appName<span class="token punctuation">,</span>
  global<span class="token punctuation">,</span>
  sandboxContainer<span class="token operator">?.</span>instance<span class="token operator">?.</span>latestSetProp<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上文有介绍到 <code>execScripts</code> 是执行子应用JS代码的方法，它接收的第一个参数就是 <code>global</code>，传入这个 <code>global</code> 后，子应用的运行将以 <code>global</code> 作为全局变量，这一步的实现就是类似下面的这段Demo</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// 子应用的运行水箱</span>
<span class="token comment">// 这里对全局window 的操作将被隔离，不会影响到外部的全局 window</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// window 将用传入的 proxy 代替</span>
</code></pre></div><p>执行完 <code>execScripts</code> 后将返回的 <code>bootstrap</code>, <code>mount</code>, <code>unmount</code>, <code>update</code> 这个导出的方法</p> <p><strong>获取微应用中全局状态相关的设置</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    onGlobalStateChange<span class="token punctuation">,</span>
    setGlobalState<span class="token punctuation">,</span>
    offGlobalStateChange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> CallableFunction<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">getMicroAppStateActions</span><span class="token punctuation">(</span>appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后就是执行挂载后的钩子了</p> <p>到此大致梳理了一下加载子应用的执行过程，接下来针对一些个别地方再深入了解一下</p> <h2 id="子应用沙箱"><a href="#子应用沙箱" class="header-anchor">#</a> 子应用沙箱</h2> <p>接下来看看 qiankun 沙箱的实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 生成应用运行时沙箱
 *
 * 沙箱分两个类型：
 * 1. app 环境沙箱
 *  app 环境沙箱是指应用初始化过之后，应用会在什么样的上下文环境运行。每个应用的环境沙箱只会初始化一次，因为子应用只会触发一次 bootstrap 。
 *  子应用在切换时，实际上切换的是 app 环境沙箱。
 * 2. render 沙箱
 *  子应用在 app mount 开始前生成好的的沙箱。每次子应用切换过后，render 沙箱都会重现初始化。
 *
 * 这么设计的目的是为了保证每个子应用切换回来之后，还能运行在应用 bootstrap 之后的环境下。
 *
 * @param appName
 * @param elementGetter
 * @param scopedCSS
 * @param useLooseSandbox
 * @param excludeAssetFilter
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createSandboxContainer</span><span class="token punctuation">(</span>
  appName<span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">elementGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  scopedCSS<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  useLooseSandbox<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sandbox<span class="token operator">:</span> SandBox<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sandbox <span class="token operator">=</span> useLooseSandbox <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">LegacySandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ProxySandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    sandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnapshotSandbox</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> bootstrappingFreers <span class="token operator">=</span> <span class="token function">patchAtBootstrapping</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> mountingFreers<span class="token operator">:</span> Freer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> sideEffectsRebuilders<span class="token operator">:</span> Rebuilder<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    instance<span class="token operator">:</span> sandbox<span class="token punctuation">,</span>
    <span class="token comment">/**
     * 沙箱被 mount
     * 可能是从 bootstrap 状态进入的 mount
     * 也可能是从 unmount 之后再次唤醒进入 mount
     */</span>
    <span class="token keyword">async</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* ------------------------------------------ 因为有上下文依赖（window），以下代码执行顺序不能变 ------------------------------------------ */</span>

      <span class="token comment">/* ------------------------------------------ 1. 启动/恢复 沙箱------------------------------------------ */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 恢复 global 状态，使其能回到应用加载之前的状态
     */</span>
    <span class="token keyword">async</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据情况上面有三个创建沙箱的方式：<code>ProxySandbox</code>、 <code>LegacySandbox</code>、 <code>SnapshotSandbox</code></p> <h3 id="proxysandbox"><a href="#proxysandbox" class="header-anchor">#</a> ProxySandbox</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 基于 Proxy 实现的沙箱
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ProxySandbox</span> <span class="token keyword">implements</span> <span class="token class-name">SandBox</span> <span class="token punctuation">{</span>
  <span class="token comment">/** window 值变更记录 */</span>
  <span class="token keyword">private</span> updatedValueSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>PropertyKey<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  name<span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token comment">// 沙箱的名字</span>
  type<span class="token operator">:</span> SandBoxType<span class="token punctuation">;</span> <span class="token comment">// 沙箱的类型</span>
  proxy<span class="token operator">:</span> WindowProxy<span class="token punctuation">;</span> <span class="token comment">// 沙箱导出的代理实体</span>
  sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 沙箱是否在运行中</span>
  latestSetProp<span class="token operator">:</span> PropertyKey <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 启动沙箱</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> activeSandboxCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">inactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 关闭沙箱</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun:sandbox] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> modified global properties restore...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>updatedValueSet<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>activeSandboxCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      variableWhiteList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>proxy<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// @ts-ignore</span>
          <span class="token keyword">delete</span> window<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> SandBoxType<span class="token punctuation">.</span>Proxy<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> updatedValueSet <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rawWindow <span class="token operator">=</span> window<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> fakeWindow<span class="token punctuation">,</span> propertiesWithGetter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createFakeWindow</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> descriptorTargetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>PropertyKey<span class="token punctuation">,</span> SymbolTarget<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">hasOwnProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token operator">:</span> PropertyKey</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fakeWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> rawWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// prosy 配置</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
    activeSandboxCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>源码中说明了 <code>ProxySandbox</code> 类中几个属性的意思：</p> <ul><li><p><code>name</code>：沙箱的名字</p></li> <li><p><code>type</code>：沙箱的类型</p></li> <li><p><code>proxy</code>：沙箱导出的代理实体</p></li> <li><p><code>sandboxRunning</code>：沙箱是否在运行中</p></li> <li><p><code>latestSetProp</code>： latest set property</p></li> <li><p><code>active</code>：启动沙箱</p></li> <li><p><code>inactive</code>：关闭沙箱</p></li></ul> <p>从 <code>constructor</code> 中的代码可以看到核心就是使用 <code>proxy</code> 给 <code>fakeWindow</code> 设置了代理，<code>fakeWindow</code> 是通过 <code>createFakeWindow(rawWindow)</code> 方法创建的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createFakeWindow</span><span class="token punctuation">(</span><span class="token parameter">global<span class="token operator">:</span> Window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> propertiesWithGetter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>PropertyKey<span class="token punctuation">,</span> boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fakeWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> FakeWindow<span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>descriptor<span class="token operator">?.</span>configurable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hasGetter <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          p <span class="token operator">===</span> <span class="token string">'top'</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">'parent'</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">'self'</span> <span class="token operator">||</span>
          p <span class="token operator">===</span> <span class="token string">'window'</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'test'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">'mockTop'</span> <span class="token operator">||</span> p <span class="token operator">===</span> <span class="token string">'mockSafariTop'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          descriptor<span class="token punctuation">.</span>configurable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasGetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            descriptor<span class="token punctuation">.</span>writable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasGetter<span class="token punctuation">)</span> propertiesWithGetter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 利用 Object.definedProperty 代理 window属性到fakeWindow对象中</span>
        <span class="token function">rawObjectDefineProperty</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> p<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    fakeWindow<span class="token punctuation">,</span>
    propertiesWithGetter<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解释 <code>createFakeWindow</code> 的代码前，先简单回顾一下对象的属性描述符</p> <p><strong>对象属性描述符</strong></p> <p>对象目前存在两种主要形式的属性描述符：数据描述符和存取描述符</p> <ul><li><p>数据描述符可选的键值为：</p> <ul><li><p>value： 该属性对应的值。可以是任何有效的 JavaScript 值（数值，对象，函数等）</p></li> <li><p>writable：当且仅当该属性的 <code>writable</code> 键值为 <code>true</code> 时，属性的值，也就是上面的 <code>value</code>，才能被赋值运算符改变</p></li></ul></li> <li><p>存取描述符可选的键值为：</p> <ul><li><p>get：当访问该属性时，会调用此函数</p></li> <li><p>set：当属性值被修改时，会调用此函数</p></li></ul></li> <li><p>数据描述符存取描述符都有的键值为：</p> <ul><li><p>configurable：当且仅当该属性的 <code>configurable</code> 键值为 <code>true</code> 时，该属性的描述符才能够被改变，同时该属性也能从对应的对象上被删除</p></li> <li><p>enumerable: 当且仅当该属性的 <code>enumerable</code> 键值为 <code>true</code> 时，该属性才会出现在对象的枚举属性中</p></li></ul></li></ul> <p>回到 <code>createFakeWindow</code> 中，它的作用就是遍历 <code>window</code> 所有自身属性，找出具有描述符的属性，对于这些属性进行以下操作：</p> <ol><li><p>使用 <code>Object.defineProperty</code> 将这些属性代理到 <code>fakeWindow</code> 对象上</p></li> <li><p>如果是具有存取描述符（get方法），将这个属性保存到 <code>propertiesWithGetter</code> 中</p></li></ol> <p>最后返回 <code>fakeWindow</code> 和 <code>propertiesWithGetter</code>，总结一下这两个值：</p> <ul><li><p>fakeWindow： 代理了 <code>window</code> 后的值</p></li> <li><p>propertiesWithGetter: 保存 <code>window</code> 上具有存取描述符的一些属性</p></li></ul> <p>回到 <code>ProxySandbox</code> 构建函中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>proxy</code> 代理了 <code>fakeWindow</code> 对象，注意 <code>fakeWindow</code> 表示真正的全局环境 <code>window</code>，<code>proxy</code> 则是当前子应用的全局环境</p> <p>接着重点看<code>Proxy</code>中 <code>set</code> 和 <code>get</code> 方法的实现</p> <p><strong>set</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  set<span class="token operator">:</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> FakeWindow<span class="token punctuation">,</span> p<span class="token operator">:</span> PropertyKey<span class="token punctuation">,</span> value<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">boolean</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sandboxRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We must kept its description while the property existed in rawWindow before</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rawWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> writable<span class="token punctuation">,</span> configurable<span class="token punctuation">,</span> enumerable <span class="token punctuation">}</span> <span class="token operator">=</span> descriptor<span class="token operator">!</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            configurable<span class="token punctuation">,</span>
            enumerable<span class="token punctuation">,</span>
            writable<span class="token punctuation">,</span>
            value<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-ignore</span>
        target<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>variableWhiteList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-ignore</span>
        rawWindow<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      updatedValueSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>latestSetProp <span class="token operator">=</span> p<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] Set window.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> while sandbox destroyed or inactive in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在 strict-mode 下，Proxy 的 handler.set 返回 false 会抛出 TypeError，在沙箱卸载的情况下应该忽略错误</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>上面代码出现的 <code>target</code>，表示当前子应用运行全局环境<code>proxy</code>；<code>rawWindow</code> 表示真正的全局环境 <code>window</code>。梳理一下 <code>set</code> 的实现逻辑：</p> <ul><li><p>如果当前这个属性不存在当前的 <code>proxy</code> 但又存在于 <code>rawWindow</code> 中，则通过 <code>Object.defineProperty</code> 给当前这个 <code>proxy</code> 添加一个代理</p></li> <li><p>如果当前属性已经存于 <code>prosy</code> 中，则直接添加修改这个值</p></li> <li><p><code>variableWhiteList</code> 是一个数组，保存着可以对 <code>rawWindow</code> 进行修改的属性，如果当前修改的属性符合条件，那么也对 <code>rawWindow</code> 中的属性进行修改</p> <p>源码 <code>variableWhiteList</code> 中的属性不多： <code>['System', '__cjsWrapper', ''__REACT_ERROR_OVERLAY_GLOBAL_HOOK__'']</code></p></li> <li><p><code>updatedValueSet</code> 是一个 <code>Set</code> 结构，作用是保存变更记录，也就是说对当前 <code>proxy</code> 进行了修改的属性都会保存到 <code>updatedValueSet</code> 中</p></li> <li><p><code>this.latestSetProp = p</code>，记录最后一个修改的属性</p></li></ul> <p><strong>get</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token operator">:</span> FakeWindow<span class="token punctuation">,</span> p<span class="token operator">:</span> PropertyKey<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
    <span class="token comment">// mark the symbol to document while accessing as document.createElement could know is invoked by which sandbox for dynamic append patcher</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">===</span> <span class="token string">'document'</span> <span class="token operator">||</span> p <span class="token operator">===</span> <span class="token string">'eval'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentRunningSandboxProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// FIXME if you have any other good ideas</span>
      <span class="token comment">// remove the mark in next tick, thus we can identify whether it in micro app or not</span>
      <span class="token comment">// this approach is just a workaround, it could not cover all complex cases, such as the micro app runs in the same task context with master in some case</span>
      <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCurrentRunningSandboxProxy</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'document'</span><span class="token operator">:</span>
          <span class="token keyword">return</span> document<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'eval'</span><span class="token operator">:</span>
          <span class="token comment">// eslint-disable-next-line no-eval</span>
          <span class="token keyword">return</span> eval<span class="token punctuation">;</span>
        <span class="token comment">// no default</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// eslint-disable-next-line no-nested-ternary</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> propertiesWithGetter<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token punctuation">(</span>rawWindow <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span>
      <span class="token operator">:</span> p <span class="token keyword">in</span> target
      <span class="token operator">?</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span>
      <span class="token operator">:</span> <span class="token punctuation">(</span>rawWindow <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getTargetValue</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p><code>get</code> 的实现有一个判断分支 <code>if (p === 'document' || p === 'eval')</code>，大概意思是如果在当前环境执行了 <code>document</code> 和 <code>eval</code>，则将当前 <code>proxy</code> 保存到一个临时变量中，在下一次事件循环后再将这个临时变量设为 <code>null</code>，至于这个临时什么时候用这晨暂不深究，总之这个临时存储的 <code>prosy</code> 仅在当前事件循环中会被用到</p> <p>这里重点看到最后一段取值逻辑，用了几个三目运算符，总结来说是就是优先从当前全局环境 <code>proxy</code> 找值，如果不存在再从 <code>rawWindow</code> 中取值</p> <p>最后 <code>getTargetValue(rawWindow, value)</code> 作用是判断这个属性是否是一些特殊的属性，是的话再额外做下处理，个别情况这里也不去关心了，总之最终的取值逻辑就是：<code>prost[properrty]||rawWindow[properrty]</code></p> <p>看到这里其实就差不多揭开了 qiankun 实现运行环境沙箱的神秘面纱，上文的 <code>proxy</code> 将用于子应用运行时充当全局 <code>window</code> 的角色，为了方便理解，写了一个简单的Demo:</p> <div class="language-js extra-class"><pre class="language-js"><code>	<span class="token keyword">let</span> fakeWindow <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> rawWindow <span class="token operator">=</span> window
	<span class="token keyword">function</span> <span class="token function">createFakeWindow</span><span class="token punctuation">(</span><span class="token parameter">global<span class="token operator">=</span>window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> descriptor<span class="token punctuation">.</span>configurable<span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>fakeWindow<span class="token punctuation">,</span> p<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> fakeWindow<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token function">createFakeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rawWindow<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>rawWindow<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> writable<span class="token punctuation">,</span> configurable<span class="token punctuation">,</span> enumerable <span class="token punctuation">}</span> <span class="token operator">=</span> descriptor
                <span class="token keyword">if</span> <span class="token punctuation">(</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        configurable<span class="token punctuation">,</span>
                        enumerable<span class="token punctuation">,</span>
                        writable<span class="token punctuation">,</span>
                        value<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> target<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token operator">||</span>rawWindow<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>youName<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
    proxy<span class="token punctuation">.</span>youName <span class="token operator">=</span> <span class="token string">'lanjz'</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>youName<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>youName<span class="token punctuation">)</span> <span class="token comment">// lanjz</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>document<span class="token punctuation">)</span> <span class="token comment">// #document</span>
</code></pre></div><p>加外两个沙条实现原理暂时先不看了 <code>LegacySandbox</code>、 <code>SnapshotSandbox</code></p> <h2 id="关于动态创建的样式和脚本"><a href="#关于动态创建的样式和脚本" class="header-anchor">#</a> 关于动态创建的样式和脚本</h2> <p>对于动态创建的样式和脚本，qiankun 也做了处理，这部分的处理逻辑在创建沙箱时定义的，分别 <code>mount</code> 和 <code>unmount</code> 两个属性方法中，先看下 <code>mount</code> 的定义</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">/**
     * 沙箱被 mount
     * 可能是从 bootstrap 状态进入的 mount
     * 也可能是从 unmount 之后再次唤醒进入 mount
     */</span>
    <span class="token keyword">async</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* ------------------------------------------ 1. 启动/恢复 沙箱------------------------------------------ */</span>
      sandbox<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sideEffectsRebuildersAtBootstrapping <span class="token operator">=</span> sideEffectsRebuilders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bootstrappingFreers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sideEffectsRebuildersAtMounting <span class="token operator">=</span> sideEffectsRebuilders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>bootstrappingFreers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sideEffectsRebuildersAtBootstrapping<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sideEffectsRebuildersAtBootstrapping<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rebuild</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* ------------------------------------------ 2. 开启全局变量补丁 ------------------------------------------*/</span>
      <span class="token comment">// render 沙箱启动时开始劫持各类全局监听，尽量不要在应用初始化阶段有 事件监听/定时器 等副作用</span>
      mountingFreers <span class="token operator">=</span> <span class="token function">patchAtMounting</span><span class="token punctuation">(</span>appName<span class="token punctuation">,</span> elementGetter<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> scopedCSS<span class="token punctuation">,</span> excludeAssetFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* ------------------------------------------ 3. 重置一些初始化时的副作用 ------------------------------------------*/</span>
      <span class="token comment">// 存在 rebuilder 则表明有些副作用需要重建</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sideEffectsRebuildersAtMounting<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sideEffectsRebuildersAtMounting<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rebuild</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// clean up rebuilders</span>
      sideEffectsRebuilders <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>根据注释，大致可以理解这段代码的作用就是从 <code>sideEffectsRebuilders</code> 中取出事件然后执行这些事件的过程，所以先要搞懂 <code>sideEffectsRebuilders</code> 和 <code>bootstrappingFreers</code> 这两个是什么东西</p> <p><strong>sideEffectsRebuilders</strong></p> <p><code>sideEffectsRebuilders</code> 出现的地方就三处：</p> <ol><li><p>定义时：<code>let sideEffectsRebuilders: Rebuilder[] = []</code></p></li> <li><p>在 <code>mount</code> 执行时会取出 <code>sideEffectsRebuilders</code>，并执行，最后清空操作：<code>sideEffectsRebuilders = []</code></p></li> <li><p>在 <code>unmount</code> 阶段也会取出 <code>sideEffectsRebuilders</code>，并执行</p></li></ol> <p>总之这些事件是 <code>sideEffectsRebuilders</code> 和 <code>mountingFreers</code> 组成的，看下他们的定义</p> <p><strong>sideEffectsRebuilders</strong></p> <p>这个变量的定义是在当前沙箱的构造函数中定义的：<code>const bootstrappingFreers = patchAtBootstrapping(appName, elementGetter, sandbox, scopedCSS, excludeAssetFilter)</code></p> <p><code>patchAtBootstrapping</code> 根据当前的全局环境代理方式的不同返回不同函数，这里我们看 <code>patchStrictSandbox(appName, elementGetter, sandbox.proxy, false, scopedCSS, excludeAssetFilter)</code>，也是意味着 <code>bootstrappingFreers</code> 是 <code>patchStrictSandbox</code> 方法返回的，看下它的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> bootstrappingPatchCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> mountingPatchCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchStrictSandbox</span><span class="token punctuation">(</span>
  appName<span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">appWrapperGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HTMLElement <span class="token operator">|</span> ShadowRoot<span class="token punctuation">,</span>
  proxy<span class="token operator">:</span> Window<span class="token punctuation">,</span>
  mounting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  scopedCSS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  excludeAssetFilter<span class="token operator">?</span><span class="token operator">:</span> CallableFunction<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Freer <span class="token punctuation">{</span>
  <span class="token keyword">let</span> containerConfig <span class="token operator">=</span> proxyAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>containerConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    containerConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
      appName<span class="token punctuation">,</span>
      proxy<span class="token punctuation">,</span>
      appWrapperGetter<span class="token punctuation">,</span>
      dynamicStyleSheetElements<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      strictGlobal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      excludeAssetFilter<span class="token punctuation">,</span>
      scopedCSS<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 每个代理环境都映射一个 containerConfig</span>
    proxyAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> containerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 所以有动态样式表都保存在 dynamicStyleSheetElements</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> dynamicStyleSheetElements <span class="token punctuation">}</span> <span class="token operator">=</span> containerConfig<span class="token punctuation">;</span>
  <span class="token comment">// 劫持 document.createElements方法</span>
  <span class="token keyword">const</span> unpatchDocumentCreate <span class="token operator">=</span> <span class="token function">patchDocumentCreateElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 劫持appdentChild和removeChild方法</span>
  <span class="token keyword">const</span> unpatchDynamicAppendPrototypeFunctions <span class="token operator">=</span> <span class="token function">patchHTMLDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounting<span class="token punctuation">)</span> bootstrappingPatchCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mounting<span class="token punctuation">)</span> mountingPatchCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// bootstrap patch just called once but its freer will be called multiple times</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounting <span class="token operator">&amp;&amp;</span> bootstrappingPatchCount <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> bootstrappingPatchCount<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mounting<span class="token punctuation">)</span> mountingPatchCount<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> allMicroAppUnmounted <span class="token operator">=</span> mountingPatchCount <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bootstrappingPatchCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// release the overwrite prototype after all the micro apps unmounted</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allMicroAppUnmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unpatchDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unpatchDocumentCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 记录样式表</span>
    <span class="token function">recordStyledComponentsCSSRules</span><span class="token punctuation">(</span>dynamicStyleSheetElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rebuildCSSRules</span><span class="token punctuation">(</span>dynamicStyleSheetElements<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stylesheetElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> appWrapper <span class="token operator">=</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取出样式表执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>appWrapper<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">rawHeadAppendChild</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appWrapper<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对每个代理 <code>proxy</code> 都对应了一个 <code>containerConfig</code> 对象，根据注释可以知道动态样式的创建会保存到 <code>dynamicStyleSheetElements</code> 属性中</p> <p>然后执行  <code>const unpatchDocumentCreate = patchDocumentCreateElement()</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// patchers/dynamicAppend/patchAtBootstrapping</span>
<span class="token keyword">const</span> rawDocumentCreateElement <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement<span class="token punctuation">;</span>
<span class="token keyword">const</span> proxyAttachContainerConfigMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span>WindowProxy<span class="token punctuation">,</span> ContainerConfig<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> elementAttachContainerConfigMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span>HTMLElement<span class="token punctuation">,</span> ContainerConfig<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">patchDocumentCreateElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement <span class="token operator">===</span> rawDocumentCreateElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> createElement<span class="token operator">&lt;</span><span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token class-name">keyof</span> HTMLElementTagNameMap<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token operator">:</span> Document<span class="token punctuation">,</span>
      tagName<span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">,</span>
      options<span class="token operator">?</span><span class="token operator">:</span> ElementCreationOptions<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">rawDocumentCreateElement</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHijackingTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> currentRunningSandboxProxy <span class="token operator">=</span> <span class="token function">getCurrentRunningSandboxProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRunningSandboxProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> proxyContainerConfig <span class="token operator">=</span> proxyAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentRunningSandboxProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyContainerConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> proxyContainerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unpatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>createElement <span class="token operator">=</span> rawDocumentCreateElement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>patchDocumentCreateElement</code> 的作用其实就是劫持了原生的 <code>Document.prototype.createElement</code> 方法。具体流程为：</p> <ol><li><p>当触发了 <code>Document.prototype.createElement</code> 后先调用原生的<code>createElement</code> 方法获取结果 <code>element</code></p></li> <li><p>通过 <code>if (isHijackingTag(tagName))</code> 语句来判断是否做进一步处理，<code>isHijackingTag(tagName)</code> 表示当前动态创建元素是否是 <code>SCRIPT</code>、<code>LINK</code>、<code>STYLE</code> 中的一种，如果是的话以<code>key-value</code> 形式保存到 <code>elementAttachContainerConfigMap</code>中</p> <ul><li><p>key：当前动态创建元素</p></li> <li><p>value: 当前 <code>代理环境proxy</code> 对应的 <code>containerConfig</code></p></li></ul></li></ol> <p>这里我暂时理解为动态创建的元素与当前 <code>代理环境proxy</code> 做了映射关系，应该是为了方便之后根据 <code>动态元素</code> 找到当前的所属的 <code>代理环境proxy</code></p> <p>回到 <code>patchStrictSandbox</code> 方法中，继续往下走执行以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> unpatchDynamicAppendPrototypeFunctions <span class="token operator">=</span> <span class="token function">patchHTMLDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> elementAttachContainerConfigMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// patchers/dynamicAppend/common.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchHTMLDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span>
  <span class="token function-variable function">isInvokedByMicroApp</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean<span class="token punctuation">,</span>
  <span class="token function-variable function">containerConfigGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ContainerConfig<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Just overwrite it while it have not been overwrite</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>appendChild <span class="token operator">===</span> rawHeadAppendChild <span class="token operator">&amp;&amp;</span>
    <span class="token class-name">HTMLBodyElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>appendChild <span class="token operator">===</span> rawBodyAppendChild <span class="token operator">&amp;&amp;</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>insertBefore <span class="token operator">===</span> rawHeadInsertBefore
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>appendChild <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      rawDOMAppendOrInsertBefore<span class="token operator">:</span> rawHeadAppendChild<span class="token punctuation">,</span>
      containerConfigGetter<span class="token punctuation">,</span>
      isInvokedByMicroApp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawHeadAppendChild<span class="token punctuation">;</span>
    <span class="token class-name">HTMLBodyElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>appendChild <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      rawDOMAppendOrInsertBefore<span class="token operator">:</span> rawBodyAppendChild<span class="token punctuation">,</span>
      containerConfigGetter<span class="token punctuation">,</span>
      isInvokedByMicroApp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawBodyAppendChild<span class="token punctuation">;</span>

    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>insertBefore <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      rawDOMAppendOrInsertBefore<span class="token operator">:</span> rawHeadInsertBefore <span class="token keyword">as</span> any<span class="token punctuation">,</span>
      containerConfigGetter<span class="token punctuation">,</span>
      isInvokedByMicroApp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawHeadInsertBefore<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Just overwrite it while it have not been overwrite</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeChild <span class="token operator">===</span> rawHeadRemoveChild <span class="token operator">&amp;&amp;</span>
    <span class="token class-name">HTMLBodyElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeChild <span class="token operator">===</span> rawBodyRemoveChild
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeChild <span class="token operator">=</span> <span class="token function">getNewRemoveChild</span><span class="token punctuation">(</span>
      rawHeadRemoveChild<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">containerConfigGetter</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span>appWrapperGetter<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HTMLBodyElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeChild <span class="token operator">=</span> <span class="token function">getNewRemoveChild</span><span class="token punctuation">(</span>
      rawBodyRemoveChild<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">containerConfigGetter</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span>appWrapperGetter<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unpatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>appendChild <span class="token operator">=</span> rawHeadAppendChild<span class="token punctuation">;</span>
    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeChild <span class="token operator">=</span> rawHeadRemoveChild<span class="token punctuation">;</span>
    <span class="token class-name">HTMLBodyElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>appendChild <span class="token operator">=</span> rawBodyAppendChild<span class="token punctuation">;</span>
    <span class="token class-name">HTMLBodyElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>removeChild <span class="token operator">=</span> rawBodyRemoveChild<span class="token punctuation">;</span>

    <span class="token class-name">HTMLHeadElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>insertBefore <span class="token operator">=</span> rawHeadInsertBefore<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>patchHTMLDynamicAppendPrototypeFunctions</code> 方法也是劫持了原生的 <code>appendChild</code>、<code>removeChild</code>等创建元素相关的方法，我们拿</p> <p>以 <code>appendChild</code> 为例，看下重写方法中做了哪些事件:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span>opts<span class="token operator">:</span> <span class="token punctuation">{</span>
  rawDOMAppendOrInsertBefore<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Node</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">newChild<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> refChild<span class="token operator">?</span><span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token function-variable function">isInvokedByMicroApp</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean<span class="token punctuation">;</span>
  <span class="token function-variable function">containerConfigGetter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ContainerConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> appendChildOrInsertBefore<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Node</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token operator">:</span> HTMLHeadElement <span class="token operator">|</span> HTMLBodyElement<span class="token punctuation">,</span>
    newChild<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    refChild<span class="token operator">?</span><span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> newChild <span class="token keyword">as</span> any<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> rawDOMAppendOrInsertBefore<span class="token punctuation">,</span> isInvokedByMicroApp<span class="token punctuation">,</span> containerConfigGetter <span class="token punctuation">}</span> <span class="token operator">=</span> opts<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHijackingTag</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isInvokedByMicroApp</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> refChild<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> containerConfig <span class="token operator">=</span> <span class="token function">containerConfigGetter</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>
        appName<span class="token punctuation">,</span>
        appWrapperGetter<span class="token punctuation">,</span>
        proxy<span class="token punctuation">,</span>
        strictGlobal<span class="token punctuation">,</span>
        dynamicStyleSheetElements<span class="token punctuation">,</span>
        scopedCSS<span class="token punctuation">,</span>
        excludeAssetFilter<span class="token punctuation">,</span>
      <span class="token punctuation">}</span> <span class="token operator">=</span> containerConfig<span class="token punctuation">;</span>

      <span class="token keyword">switch</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">LINK_TAG_NAME</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">STYLE_TAG_NAME</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 动态样式时执行的语句</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token constant">SCRIPT_TAG_NAME</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 动态脚本时执行的语句</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> refChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从上面定义可以看到根据动态创建的目标不同，处理方式也不同，先看样式的处理：</p> <p><strong>动态样式</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> stylesheetElement<span class="token operator">:</span> HTMLLinkElement <span class="token operator">|</span> HTMLStyleElement <span class="token operator">=</span> newChild <span class="token keyword">as</span> any<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> href <span class="token punctuation">}</span> <span class="token operator">=</span> stylesheetElement <span class="token keyword">as</span> HTMLLinkElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>excludeAssetFilter <span class="token operator">&amp;&amp;</span> href <span class="token operator">&amp;&amp;</span> <span class="token function">excludeAssetFilter</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> refChild<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mountDOM <span class="token operator">=</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>scopedCSS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// exclude link elements like &lt;link rel=&quot;icon&quot; href=&quot;favicon.ico&quot;&gt;</span>
    <span class="token keyword">const</span> linkElementUsingStylesheet <span class="token operator">=</span>
      element<span class="token punctuation">.</span>tagName<span class="token operator">?.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">LINK_TAG_NAME</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>element <span class="token keyword">as</span> HTMLLinkElement<span class="token punctuation">)</span><span class="token punctuation">.</span>rel <span class="token operator">===</span> <span class="token string">'stylesheet'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>element <span class="token keyword">as</span> HTMLLinkElement<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>linkElementUsingStylesheet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fetch <span class="token operator">=</span>
        <span class="token keyword">typeof</span> frameworkConfiguration<span class="token punctuation">.</span>fetch <span class="token operator">===</span> <span class="token string">'function'</span>
          <span class="token operator">?</span> frameworkConfiguration<span class="token punctuation">.</span>fetch
          <span class="token operator">:</span> frameworkConfiguration<span class="token punctuation">.</span>fetch<span class="token operator">?.</span>fn<span class="token punctuation">;</span>
      stylesheetElement <span class="token operator">=</span> <span class="token function">convertLinkAsStyle</span><span class="token punctuation">(</span>
        element<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">styleElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> css<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>mountDOM<span class="token punctuation">,</span> styleElement<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">,</span>
        fetch<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      dynamicLinkAttachedInlineStyleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      css<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>mountDOM<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// eslint-disable-next-line no-shadow</span>
  dynamicStyleSheetElements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> referenceNode <span class="token operator">=</span> mountDOM<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>refChild<span class="token punctuation">)</span> <span class="token operator">?</span> refChild <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>mountDOM<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>excludeAssetFilter</code> 可以在使用 <code>registerMicroApps</code> 时传入，表示如果动态创建的链接包含在 <code>excludeAssetFilter</code> 中则不做任何处理</p> <p>后面出现的 <code>mountDOM</code> 表示当前子应用 DOM 内容 ； <code>scopedCSS</code> 表示是设置了 <code>experimentalStyleIsolation: true</code></p> <p>如果当前创建是动态 <code>link</code> 标签则调用 <code>convertLinkAsStyle</code> 方法使用 <code>fetch</code> 获取样式文件内容并调用 <code>css.process(mountDOM, styleElement, appName)</code> ；如果是动态创建的内联样式则直接执行 <code>css.process(mountDOM, stylesheetElement, appName)</code></p> <p><code>css.process</code> 的作用就是给些这样式内容添加特殊的选择器，用于隔离样式使用</p> <p>之后把当前这个创建的元素保存到 <code>containerConfig.dynamicStyleSheetElements</code></p> <p>最后执行 <code>rawDOMAppendOrInsertBefore.call(mountDOM, stylesheetElement, referenceNode)</code> 即原生的 <code>HTMLHeadElement.prototype.appendChild</code> 的方法，将样式内容添加到DOM中，注意添加到子应用中的DOM</p> <p><strong>动态脚本</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> text <span class="token punctuation">}</span> <span class="token operator">=</span> element <span class="token keyword">as</span> HTMLScriptElement<span class="token punctuation">;</span>
  <span class="token comment">// some script like jsonp maybe not support cors which should't use execScripts</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>excludeAssetFilter <span class="token operator">&amp;&amp;</span> src <span class="token operator">&amp;&amp;</span> <span class="token function">excludeAssetFilter</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> refChild<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mountDOM <span class="token operator">=</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fetch <span class="token punctuation">}</span> <span class="token operator">=</span> frameworkConfiguration<span class="token punctuation">;</span>
  <span class="token keyword">const</span> referenceNode <span class="token operator">=</span> mountDOM<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>refChild<span class="token punctuation">)</span> <span class="token operator">?</span> refChild <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">execScripts</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>src<span class="token punctuation">]</span><span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      fetch<span class="token punctuation">,</span>
      strictGlobal<span class="token punctuation">,</span>
      <span class="token function-variable function">beforeExec</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token string">'currentScript'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
            <span class="token keyword">return</span> element<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">manualInvokeElementOnLoad</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        element <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">manualInvokeElementOnError</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        element <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> dynamicScriptCommentElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dynamic script </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> replaced by qiankun</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dynamicScriptAttachedCommentMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dynamicScriptCommentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>mountDOM<span class="token punctuation">,</span> dynamicScriptCommentElement<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// inline script never trigger the onload and onerror event</span>
  <span class="token function">execScripts</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> <span class="token punctuation">{</span> strictGlobal <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dynamicInlineScriptCommentElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span><span class="token string">'dynamic inline script replaced by qiankun'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dynamicScriptAttachedCommentMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dynamicInlineScriptCommentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">rawDOMAppendOrInsertBefore</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>mountDOM<span class="token punctuation">,</span> dynamicInlineScriptCommentElement<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其实动态创建的脚本时执行的流程跟动态样式差不太多，不过要注意的是使用 <code>execScripts</code> 执行脚本时动态设置了脚本执行的全局环境为当前子应用<code>代理prosy</code></p> <p>所以对于 <code>insertBefore</code> 的劫持逻辑大致就是这么一回事，总结一下：</p> <ol><li><p>对于样式，如果是远程资源则 <code>fetch</code> 内容后再添加到 DOM中，并将元素保存到 <code>containerConfig.dynamicStyleSheetElements</code> 中</p></li> <li><p>对于脚本，如果是远程资源则通过 <code>fetch</code> 后再执行，执行时指定全局环境到子应用中</p></li> <li><p>执行真正的 <code>insertBefore</code> 的操作，注意这些操作都将作用于子应用中</p></li></ol> <p>对于 <code>patchHTMLDynamicAppendPrototypeFunctions</code> 方法作用大致搞清楚了，那么回到 <code>patchStrictSandbox</code> 方法中继续往下走，最后就是返回 <code>free</code> 方法，<code>free</code> 返回后是会被马上执行的，所以看下 <code>free</code> 的作用</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// bootstrap patch just called once but its freer will be called multiple times</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounting <span class="token operator">&amp;&amp;</span> bootstrappingPatchCount <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> bootstrappingPatchCount<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mounting<span class="token punctuation">)</span> mountingPatchCount<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> allMicroAppUnmounted <span class="token operator">=</span> mountingPatchCount <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bootstrappingPatchCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// release the overwrite prototype after all the micro apps unmounted</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allMicroAppUnmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unpatchDynamicAppendPrototypeFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unpatchDocumentCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">recordStyledComponentsCSSRules</span><span class="token punctuation">(</span>dynamicStyleSheetElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rebuildCSSRules</span><span class="token punctuation">(</span>dynamicStyleSheetElements<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stylesheetElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> appWrapper <span class="token operator">=</span> <span class="token function">appWrapperGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>appWrapper<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">rawHeadAppendChild</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appWrapper<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>重点看下 <code>recordStyledComponentsCSSRules(dynamicStyleSheetElements)</code> 的作用记录 <code>dynamicStyleSheetElements</code> 到 <code>styledComponentCSSRulesMap</code> 中，最后返回 <code>rebuild</code> 方法</p> <p>最后我们回到调用 <code>patchHTMLDynamicAppendPrototypeFunctions</code> 也就是 <code>const bootstrappingFreers = patchAtBootstrapping(appName, elementGetter, sandbox, scopedCSS, excludeAssetFilter);</code>，这里我们知道了 <code>bootstrappingFreers</code> 得到的就是刚提到的 <code>rebuild</code> 方法</p> <p>关于 <code>rebuild</code> 方法什么场景下会调用，有点没搞清楚，这部分以后再补充吧~</p> <h2 id="样式隔离"><a href="#样式隔离" class="header-anchor">#</a> 样式隔离</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> strictStyleIsolation <span class="token operator">=</span> <span class="token keyword">typeof</span> sandbox <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>sandbox<span class="token punctuation">.</span>strictStyleIsolation<span class="token punctuation">;</span>
  <span class="token keyword">const</span> scopedCSS <span class="token operator">=</span> <span class="token function">isEnableScopedCSS</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> initialAppWrapperElement<span class="token operator">:</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
    appContent<span class="token punctuation">,</span>
    strictStyleIsolation<span class="token punctuation">,</span>
    scopedCSS<span class="token punctuation">,</span>
    appName<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码就是开始处理样式隔离的地方，首先会获取隔离规则 <code>strictStyleIsolation</code> 和 <code>scopedCSS</code>，看下 qiankun 对于这两个规则配置的含义说明：</p> <ul><li><p><code>strictStyleIsolation</code>: 为 <code>true</code> 时表示开启严格的样式隔离模式。这种模式下 qiankun 会为每个微应用的容器包裹上一个 <code>shadow dom</code> 节点，从而确保微应用的样式不会对全局造成影响</p></li> <li><p><code>experimentalStyleIsolation</code> : qiankun 会改写子应用所添加的样式为所有样式规则增加一个特殊的选择器规则来限定其影响范围，因此改写后的代码会表达类似为如下结构：</p> <div class="language-css extra-class"><pre class="language-css"><code> <span class="token selector">.app-main</span> <span class="token punctuation">{</span>
   <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token selector">div[data-qiankun-react16] .app-main</span> <span class="token punctuation">{</span>
   <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div></li></ul> <p>看下 <code>createElement</code> 方法的定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token parameter">appContent<span class="token operator">:</span> string<span class="token punctuation">,</span>
  strictStyleIsolation<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  scopedCSS<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  appName<span class="token operator">:</span> string<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token keyword">const</span> containerElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  containerElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> appContent<span class="token punctuation">;</span>
  <span class="token comment">// appContent always wrapped with a singular div</span>
  <span class="token keyword">const</span> appElement <span class="token operator">=</span> containerElement<span class="token punctuation">.</span>firstChild <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strictStyleIsolation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportShadowDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> innerHTML <span class="token punctuation">}</span> <span class="token operator">=</span> appElement<span class="token punctuation">;</span>
      appElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> shadow<span class="token operator">:</span> ShadowRoot<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>appElement<span class="token punctuation">.</span>attachShadow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shadow <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// createShadowRoot was proposed in initial spec, which has then been deprecated</span>
        shadow <span class="token operator">=</span> <span class="token punctuation">(</span>appElement <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createShadowRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      shadow<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> innerHTML<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>scopedCSS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> attr <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      appElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> styleNodes <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">forEach</span><span class="token punctuation">(</span>styleNodes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stylesheetElement<span class="token operator">:</span> HTMLStyleElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      css<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>appElement<span class="token operator">!</span><span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> appElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重点就是下面两个 <code>if</code>：<code>if (strictStyleIsolation)</code> 和 <code>if (scopedCSS)</code>，分别看下他们的实现</p> <h3 id="strictstyleisolation"><a href="#strictstyleisolation" class="header-anchor">#</a> strictStyleIsolation</h3> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_shadow_DOM" target="_blank" rel="noopener noreferrer">shadow DOM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Web components 的一个重要属性是封装——可以将标记结构、样式和行为隐藏起来，并与页面上的其他代码相隔离，保证不同的部分不会混在一起，可使代码更加干净、整洁。其中，Shadow DOM 接口是关键所在，它可以将一个隐藏的、独立的 DOM 附加到一个元素上。</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportShadowDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> innerHTML <span class="token punctuation">}</span> <span class="token operator">=</span> appElement<span class="token punctuation">;</span>
      appElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> shadow<span class="token operator">:</span> ShadowRoot<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>appElement<span class="token punctuation">.</span>attachShadow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shadow <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// createShadowRoot was proposed in initial spec, which has then been deprecated</span>
        shadow <span class="token operator">=</span> <span class="token punctuation">(</span>appElement <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createShadowRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      shadow<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> innerHTML<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>根据 shadow DOM 的意思所以实现<code>strictStyleIsolation</code> 模式的设置很简单，就是给应用内容包一个 <code>Shadow DOM</code></p> <h3 id="scopedcss"><a href="#scopedcss" class="header-anchor">#</a> scopedCSS</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> attr <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  appElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 给根元素设置一个 ['data-qiankun' = appName] 的属性</span>
<span class="token keyword">const</span> styleNodes <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">forEach</span><span class="token punctuation">(</span>styleNodes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stylesheetElement<span class="token operator">:</span> HTMLStyleElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  css<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>appElement<span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> QiankunCSSRewriteAttr <span class="token operator">=</span> <span class="token string">'data-qiankun'</span><span class="token punctuation">;</span>
</code></pre></div><p>获取所有的 <code>style</code> 标签，遍历他们并调用 <code>css.process</code> ，<code>css.process</code> 实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// css.process</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> process <span class="token operator">=</span> <span class="token punctuation">(</span>
  appWrapper<span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span>
  stylesheetElement<span class="token operator">:</span> HTMLStyleElement <span class="token operator">|</span> HTMLLinkElement<span class="token punctuation">,</span>
  appName<span class="token operator">:</span> string<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// lazy singleton pattern</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    processor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScopedCSS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'LINK'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Feature: sandbox.experimentalStyleIsolation is not support for link element yet.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mountDOM <span class="token operator">=</span> appWrapper<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mountDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token punctuation">(</span>mountDOM<span class="token punctuation">.</span>tagName <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">&amp;&amp;</span> stylesheetElement<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'STYLE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>QiankunCSSRewriteAttr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>从 <code>process</code> 方法定义可以看到，样式隔离只能处理内联样式，<code>link</code> 加载的样式是不能处理处理的，对于内联样式先生成一个选择器名称，之后调用 <code>processor.process</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// processor.process</span>
  <span class="token function">process</span><span class="token punctuation">(</span>styleNode<span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">,</span> prefix<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>styleNode<span class="token punctuation">.</span>textContent <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> textNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>styleNode<span class="token punctuation">.</span>textContent <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>textNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sheet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode<span class="token punctuation">.</span>sheet <span class="token keyword">as</span> any<span class="token punctuation">;</span> <span class="token comment">// type is missing</span>
      <span class="token keyword">const</span> rules <span class="token operator">=</span> arrayify<span class="token operator">&lt;</span>CSSRule<span class="token operator">&gt;</span><span class="token punctuation">(</span>sheet<span class="token operator">?.</span>cssRules <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rewrite</span><span class="token punctuation">(</span>rules<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// eslint-disable-next-line no-param-reassign</span>
      styleNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> css<span class="token punctuation">;</span>

      <span class="token comment">// cleanup</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>textNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>processor.process</code> 的作用就是给个样式属性添加之前定义的选择器属性，<code>this.rewrite</code> 方法就是具体替换实现，这里就略过了</p> <h2 id="应用通信"><a href="#应用通信" class="header-anchor">#</a> 应用通信</h2> <p>qiankun 提供了 <code>initGlobalState(state)</code> 用于应用通信，示例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalState<span class="token punctuation">,</span> MicroAppStateActions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'qiankun'</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化 state</span>
<span class="token keyword">const</span> actions<span class="token operator">:</span> MicroAppStateActions <span class="token operator">=</span> <span class="token function">initGlobalState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

actions<span class="token punctuation">.</span><span class="token function">onGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// state: 变更后的状态; prev 变更前的状态</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
actions<span class="token punctuation">.</span><span class="token function">setGlobalState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
actions<span class="token punctuation">.</span><span class="token function">offGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看下相关的代码的定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> cloneDeep <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> type <span class="token punctuation">{</span> OnGlobalStateChangeCallback<span class="token punctuation">,</span> MicroAppStateActions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./interfaces'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> globalState<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> deps<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> OnGlobalStateChangeCallback<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 触发全局监听</span>
<span class="token keyword">function</span> <span class="token function">emitGlobal</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span> prevState<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>prevState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initGlobalState</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> globalState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[qiankun] state has not changed！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevGlobalState <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>globalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    globalState <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">emitGlobal</span><span class="token punctuation">(</span>globalState<span class="token punctuation">,</span> prevGlobalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">getMicroAppStateActions</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">global-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getMicroAppStateActions</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> string<span class="token punctuation">,</span> isMaster<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> MicroAppStateActions <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * onGlobalStateChange 全局依赖监听
     *
     * 收集 setState 时所需要触发的依赖
     *
     * 限制条件：每个子应用只有一个激活状态的全局监听，新监听覆盖旧监听，若只是监听部分属性，请使用 onGlobalStateChange
     *
     * 这么设计是为了减少全局监听滥用导致的内存爆炸
     *
     * 依赖数据结构为：
     * {
     *   {id}: callback
     * }
     *
     * @param callback
     * @param fireImmediately
     */</span>
    <span class="token function">onGlobalStateChange</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token operator">:</span> OnGlobalStateChangeCallback<span class="token punctuation">,</span> fireImmediately<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>callback <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'[qiankun] callback must be function!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' global listener already exists before this, new listener will overwrite it.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token keyword">const</span> cloneState <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>globalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fireImmediately<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>cloneState<span class="token punctuation">,</span> cloneState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * setGlobalState 更新 store 数据
     *
     * 1. 对输入 state 的第一层属性做校验，只有初始化时声明过的第一层（bucket）属性才会被更改
     * 2. 修改 store 并触发全局监听
     *
     * @param state
     */</span>
    <span class="token function">setGlobalState</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> globalState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[qiankun] state has not changed！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> changeKeys<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> prevGlobalState <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>globalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      globalState <span class="token operator">=</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_globalState<span class="token punctuation">,</span> changeKey</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isMaster <span class="token operator">||</span> _globalState<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>changeKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            changeKeys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>changeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>_globalState<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>changeKey<span class="token punctuation">]</span><span class="token operator">:</span> state<span class="token punctuation">[</span>changeKey<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>changeKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' not declared when init state！</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> _globalState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> globalState<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>changeKeys<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[qiankun] state has not changed！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">emitGlobal</span><span class="token punctuation">(</span>globalState<span class="token punctuation">,</span> prevGlobalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 注销该应用下的依赖</span>
    <span class="token function">offGlobalStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>通过代码可以看到，qiankun 是利用发布订阅者模式来实现应用通信的</p> <p>对于整个应用只有一个用于保存全局状态的 <code>globalState</code> 和一个事件收集器 <code>deps</code>，最后执行 <code>initGlobalState</code> 函数返回一个 <code>actions</code></p> <p>子应用创建的时候会传入 <code>onGlobalStateChange</code> 和 <code>setGlobalState</code></p> <p>无论是主应用还是子应用只要触发 <code>onGlobalStateChange</code> 时，会将回调函数与当前的 <code>app id</code> 一起做个映射保存到 <code>deps</code> 中</p> <p>之后触发 <code>setGlobalState</code> 时，将深拷贝一份原本的数据保存到 <code>prevGlobalState</code> 中，之后将新的数据合到当前数据<code>globalState</code> 中，然后执行 <code>emitGlobal(globalState, prevGlobalState)</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 触发全局监听</span>
<span class="token keyword">function</span> <span class="token function">emitGlobal</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span> prevState<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span>prevState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>emitGlobal</code> 的作用就是遍历收集到的回调方法，并一一执行</p> <p>qiankun 应用通信的实现还是比较简单的，就是创建一个发布订阅者模式用来收集事件-执行事件</p> <h2 id="预加载"><a href="#预加载" class="header-anchor">#</a> 预加载</h2> <p>qiankun 预加载是通过启动 <code>start</code> 传入 <code>prefetch</code> 属性开启的，默认是 <code>true</code>。看下源码相关位置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">opts<span class="token operator">:</span> FrameworkConfiguration <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  frameworkConfiguration <span class="token operator">=</span> <span class="token punctuation">{</span> prefetch<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> singular<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> sandbox<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">...</span>opts <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> prefetch<span class="token punctuation">,</span> sandbox<span class="token punctuation">,</span> singular<span class="token punctuation">,</span> urlRerouteOnly<span class="token punctuation">,</span> <span class="token operator">...</span>importEntryOpts <span class="token punctuation">}</span> <span class="token operator">=</span> frameworkConfiguration<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prefetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果有 prefetch 执行 doPrefetchStrategy</span>
    <span class="token function">doPrefetchStrategy</span><span class="token punctuation">(</span>microApps<span class="token punctuation">,</span> prefetch<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">startSingleSpa</span><span class="token punctuation">(</span><span class="token punctuation">{</span> urlRerouteOnly <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  frameworkStartedDefer<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// doPrefetchStrategy</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">doPrefetchStrategy</span><span class="token punctuation">(</span>
  <span class="token parameter">apps<span class="token operator">:</span> AppMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  prefetchStrategy<span class="token operator">:</span> PrefetchStrategy<span class="token punctuation">,</span>
  importEntryOpts<span class="token operator">?</span><span class="token operator">:</span> ImportEntryOpts<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> appsName2Apps <span class="token operator">=</span> <span class="token punctuation">(</span>names<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> AppMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> apps<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> names<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 如果 prefetchStrategy 是数组或者函数的话，略过这里</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>prefetchStrategy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prefetchAfterFirstMounted</span><span class="token punctuation">(</span><span class="token function">appsName2Apps</span><span class="token punctuation">(</span>prefetchStrategy <span class="token keyword">as</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>prefetchStrategy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// critical rendering apps would be prefetch as earlier as possible</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> criticalAppNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> minorAppsName <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">prefetchStrategy</span><span class="token punctuation">(</span>apps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">prefetchImmediately</span><span class="token punctuation">(</span><span class="token function">appsName2Apps</span><span class="token punctuation">(</span>criticalAppNames<span class="token punctuation">)</span><span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">prefetchAfterFirstMounted</span><span class="token punctuation">(</span><span class="token function">appsName2Apps</span><span class="token punctuation">(</span>minorAppsName<span class="token punctuation">)</span><span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>prefetchStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token boolean">true</span><span class="token operator">:</span>
        <span class="token comment">// 为true 执行 prefetchAfterFirstMounted</span>
        <span class="token function">prefetchAfterFirstMounted</span><span class="token punctuation">(</span>apps<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'all'</span><span class="token operator">:</span>
        <span class="token function">prefetchImmediately</span><span class="token punctuation">(</span>apps<span class="token punctuation">,</span> importEntryOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// prefetchAfterFirstMounted</span>
<span class="token keyword">function</span> <span class="token function">prefetchAfterFirstMounted</span><span class="token punctuation">(</span><span class="token parameter">apps<span class="token operator">:</span> AppMetadata<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token operator">:</span> ImportEntryOpts</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
 <span class="token comment">// 参数是当前要预加的应用</span>
 <span class="token comment">// 添加一个监听事件</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'single-spa:first-mount'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> notLoadedApps <span class="token operator">=</span> apps<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getAppStatus</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">NOT_LOADED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> mountedApps <span class="token operator">=</span> <span class="token function">getMountedApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[qiankun] prefetch starting after </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mountedApps<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> mounted...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> notLoadedApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 当产个应用加过载后执行 prefetch</span>
    notLoadedApps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> entry <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">prefetch</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'single-spa:first-mount'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// prefetch</span>
<span class="token keyword">function</span> <span class="token function">prefetch</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token operator">:</span> Entry<span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token operator">:</span> ImportEntryOpts</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>onLine <span class="token operator">||</span> isSlowNetwork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don't prefetch if in a slow network or offline</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> getExternalScripts<span class="token punctuation">,</span> getExternalStyleSheets <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">importEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>getExternalStyleSheets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>getExternalScripts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据上面的代码 总结一下 <code>prefetch</code> 的实现：</p> <ol><li><p>注册事件 <code>single-spa:first-mount</code>，当首个应用加载完成后执行回调</p></li> <li><p>回调中过滤掉没有加载的应用，执行 <code>prefetch</code></p></li> <li><p>然后执行 <code>importEntry</code> 加载应用内容，<code>importEntry</code> 会对加载过的资源做缓存，返回的 <code>getExternalStyleSheets</code> 和 <code>getExternalScripts</code> 方法是加载对应样式资源和JS资源的方法，也会稍后执行，这些 <code>importEntry</code> 内部都会做缓存，所以下次再调用 <code>importEntry</code> 将直接从缓存中取</p></li></ol> <p><a href="https://segmentfault.com/a/1190000022275991" target="_blank" rel="noopener noreferrer"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lanjz/qiankun/微前端.html" class="prev">
        微前端
      </a></span> <span class="next"><a href="/lanjz/qiankun/importHtmlEntry.html">
        import-html-entry
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/lanjz/assets/js/app.e889b93f.js" defer></script><script src="/lanjz/assets/js/2.30c9612b.js" defer></script><script src="/lanjz/assets/js/197.90a70dd8.js" defer></script>
  </body>
</html>
