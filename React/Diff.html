<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React16 Diff | Hello Wold</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/lanjz/assets/css/0.styles.e9edb4e4.css" as="style"><link rel="preload" href="/lanjz/assets/js/app.d8d1d3b2.js" as="script"><link rel="preload" href="/lanjz/assets/js/3.9b2a8784.js" as="script"><link rel="preload" href="/lanjz/assets/js/29.d4c2b5a1.js" as="script"><link rel="prefetch" href="/lanjz/assets/js/10.7c64ab13.js"><link rel="prefetch" href="/lanjz/assets/js/100.a716f568.js"><link rel="prefetch" href="/lanjz/assets/js/101.196322c6.js"><link rel="prefetch" href="/lanjz/assets/js/102.5e3768c7.js"><link rel="prefetch" href="/lanjz/assets/js/103.499dc677.js"><link rel="prefetch" href="/lanjz/assets/js/104.af069956.js"><link rel="prefetch" href="/lanjz/assets/js/105.6c9885fb.js"><link rel="prefetch" href="/lanjz/assets/js/106.f93ba951.js"><link rel="prefetch" href="/lanjz/assets/js/107.9b6b3753.js"><link rel="prefetch" href="/lanjz/assets/js/108.c9286e0c.js"><link rel="prefetch" href="/lanjz/assets/js/109.afeed1ec.js"><link rel="prefetch" href="/lanjz/assets/js/11.bc40e5f9.js"><link rel="prefetch" href="/lanjz/assets/js/110.6967c551.js"><link rel="prefetch" href="/lanjz/assets/js/111.2af40af1.js"><link rel="prefetch" href="/lanjz/assets/js/112.8de1346e.js"><link rel="prefetch" href="/lanjz/assets/js/113.5b3be9aa.js"><link rel="prefetch" href="/lanjz/assets/js/114.52997dcf.js"><link rel="prefetch" href="/lanjz/assets/js/115.5d012db2.js"><link rel="prefetch" href="/lanjz/assets/js/116.411deb7d.js"><link rel="prefetch" href="/lanjz/assets/js/117.a6ad0096.js"><link rel="prefetch" href="/lanjz/assets/js/118.5d8245de.js"><link rel="prefetch" href="/lanjz/assets/js/119.51644c2b.js"><link rel="prefetch" href="/lanjz/assets/js/12.1ca3aeb3.js"><link rel="prefetch" href="/lanjz/assets/js/120.a50769bd.js"><link rel="prefetch" href="/lanjz/assets/js/121.37ceefb1.js"><link rel="prefetch" href="/lanjz/assets/js/122.eac395a3.js"><link rel="prefetch" href="/lanjz/assets/js/123.6b01d264.js"><link rel="prefetch" href="/lanjz/assets/js/124.80808277.js"><link rel="prefetch" href="/lanjz/assets/js/125.53883460.js"><link rel="prefetch" href="/lanjz/assets/js/126.e0fea7df.js"><link rel="prefetch" href="/lanjz/assets/js/127.fba467c6.js"><link rel="prefetch" href="/lanjz/assets/js/128.8594413b.js"><link rel="prefetch" href="/lanjz/assets/js/129.91e19937.js"><link rel="prefetch" href="/lanjz/assets/js/13.6bf2baaa.js"><link rel="prefetch" href="/lanjz/assets/js/130.a575479a.js"><link rel="prefetch" href="/lanjz/assets/js/131.5728bafa.js"><link rel="prefetch" href="/lanjz/assets/js/132.eeb7cba9.js"><link rel="prefetch" href="/lanjz/assets/js/133.1a0f6c21.js"><link rel="prefetch" href="/lanjz/assets/js/134.98687a37.js"><link rel="prefetch" href="/lanjz/assets/js/135.93eba1fa.js"><link rel="prefetch" href="/lanjz/assets/js/136.aaa9253b.js"><link rel="prefetch" href="/lanjz/assets/js/137.2575b2da.js"><link rel="prefetch" href="/lanjz/assets/js/138.38ed78b0.js"><link rel="prefetch" href="/lanjz/assets/js/139.57c4d255.js"><link rel="prefetch" href="/lanjz/assets/js/14.a73f0880.js"><link rel="prefetch" href="/lanjz/assets/js/140.6e5640cc.js"><link rel="prefetch" href="/lanjz/assets/js/141.18f77bcb.js"><link rel="prefetch" href="/lanjz/assets/js/142.dfaf32a1.js"><link rel="prefetch" href="/lanjz/assets/js/143.3ebf64b6.js"><link rel="prefetch" href="/lanjz/assets/js/144.6eb31e10.js"><link rel="prefetch" href="/lanjz/assets/js/145.1d92cabd.js"><link rel="prefetch" href="/lanjz/assets/js/146.2f7e33c4.js"><link rel="prefetch" href="/lanjz/assets/js/147.2316c9f0.js"><link rel="prefetch" href="/lanjz/assets/js/148.2caa5b9b.js"><link rel="prefetch" href="/lanjz/assets/js/149.3ea1cfee.js"><link rel="prefetch" href="/lanjz/assets/js/15.62d15d94.js"><link rel="prefetch" href="/lanjz/assets/js/150.f586624c.js"><link rel="prefetch" href="/lanjz/assets/js/151.0c33e93a.js"><link rel="prefetch" href="/lanjz/assets/js/152.6ac0010d.js"><link rel="prefetch" href="/lanjz/assets/js/153.b344bfaf.js"><link rel="prefetch" href="/lanjz/assets/js/154.4c03bc31.js"><link rel="prefetch" href="/lanjz/assets/js/155.775b7215.js"><link rel="prefetch" href="/lanjz/assets/js/156.1164d22b.js"><link rel="prefetch" href="/lanjz/assets/js/157.6d1d8ebb.js"><link rel="prefetch" href="/lanjz/assets/js/158.d6af05e2.js"><link rel="prefetch" href="/lanjz/assets/js/159.f8cfb21d.js"><link rel="prefetch" href="/lanjz/assets/js/16.59c71b94.js"><link rel="prefetch" href="/lanjz/assets/js/160.c2600a3b.js"><link rel="prefetch" href="/lanjz/assets/js/161.50837885.js"><link rel="prefetch" href="/lanjz/assets/js/162.2c85fdc3.js"><link rel="prefetch" href="/lanjz/assets/js/163.b13161c7.js"><link rel="prefetch" href="/lanjz/assets/js/164.29d9035d.js"><link rel="prefetch" href="/lanjz/assets/js/165.223e9d52.js"><link rel="prefetch" href="/lanjz/assets/js/166.8cbac89c.js"><link rel="prefetch" href="/lanjz/assets/js/167.2e052726.js"><link rel="prefetch" href="/lanjz/assets/js/168.a49745a6.js"><link rel="prefetch" href="/lanjz/assets/js/169.494faba8.js"><link rel="prefetch" href="/lanjz/assets/js/17.e0cec4a6.js"><link rel="prefetch" href="/lanjz/assets/js/170.2b2b8ab0.js"><link rel="prefetch" href="/lanjz/assets/js/171.e2475d0f.js"><link rel="prefetch" href="/lanjz/assets/js/172.cad08698.js"><link rel="prefetch" href="/lanjz/assets/js/173.678f406c.js"><link rel="prefetch" href="/lanjz/assets/js/174.63c59bf2.js"><link rel="prefetch" href="/lanjz/assets/js/175.27528490.js"><link rel="prefetch" href="/lanjz/assets/js/176.525d237d.js"><link rel="prefetch" href="/lanjz/assets/js/177.8819a1b0.js"><link rel="prefetch" href="/lanjz/assets/js/178.26ca21c2.js"><link rel="prefetch" href="/lanjz/assets/js/179.8a814150.js"><link rel="prefetch" href="/lanjz/assets/js/18.c79d8d4c.js"><link rel="prefetch" href="/lanjz/assets/js/180.ef0f025a.js"><link rel="prefetch" href="/lanjz/assets/js/181.28b013c9.js"><link rel="prefetch" href="/lanjz/assets/js/182.aaee28d2.js"><link rel="prefetch" href="/lanjz/assets/js/183.3fe12674.js"><link rel="prefetch" href="/lanjz/assets/js/184.f0d8da24.js"><link rel="prefetch" href="/lanjz/assets/js/185.23565742.js"><link rel="prefetch" href="/lanjz/assets/js/186.e88590d7.js"><link rel="prefetch" href="/lanjz/assets/js/187.5cdb6776.js"><link rel="prefetch" href="/lanjz/assets/js/188.1edae48b.js"><link rel="prefetch" href="/lanjz/assets/js/189.8c8b942d.js"><link rel="prefetch" href="/lanjz/assets/js/19.46e3a9a4.js"><link rel="prefetch" href="/lanjz/assets/js/190.afb1e424.js"><link rel="prefetch" href="/lanjz/assets/js/191.416c7b61.js"><link rel="prefetch" href="/lanjz/assets/js/192.d39a340c.js"><link rel="prefetch" href="/lanjz/assets/js/193.ceb778af.js"><link rel="prefetch" href="/lanjz/assets/js/194.8377e27d.js"><link rel="prefetch" href="/lanjz/assets/js/195.5fb00d69.js"><link rel="prefetch" href="/lanjz/assets/js/196.f6a83c4f.js"><link rel="prefetch" href="/lanjz/assets/js/197.a87d8f0b.js"><link rel="prefetch" href="/lanjz/assets/js/198.d1eef071.js"><link rel="prefetch" href="/lanjz/assets/js/199.06d1f01d.js"><link rel="prefetch" href="/lanjz/assets/js/2.f6285601.js"><link rel="prefetch" href="/lanjz/assets/js/20.74831d77.js"><link rel="prefetch" href="/lanjz/assets/js/200.70ea644e.js"><link rel="prefetch" href="/lanjz/assets/js/201.439e1004.js"><link rel="prefetch" href="/lanjz/assets/js/202.648df176.js"><link rel="prefetch" href="/lanjz/assets/js/203.ae554797.js"><link rel="prefetch" href="/lanjz/assets/js/204.4e773b51.js"><link rel="prefetch" href="/lanjz/assets/js/205.0d8f65bc.js"><link rel="prefetch" href="/lanjz/assets/js/206.931a7929.js"><link rel="prefetch" href="/lanjz/assets/js/207.79f14df0.js"><link rel="prefetch" href="/lanjz/assets/js/208.88e78da7.js"><link rel="prefetch" href="/lanjz/assets/js/209.a7aa483b.js"><link rel="prefetch" href="/lanjz/assets/js/21.dc4576de.js"><link rel="prefetch" href="/lanjz/assets/js/210.d3f8b8e0.js"><link rel="prefetch" href="/lanjz/assets/js/211.ed484b78.js"><link rel="prefetch" href="/lanjz/assets/js/212.3cba3a41.js"><link rel="prefetch" href="/lanjz/assets/js/213.437a4442.js"><link rel="prefetch" href="/lanjz/assets/js/214.873978a0.js"><link rel="prefetch" href="/lanjz/assets/js/215.641904d4.js"><link rel="prefetch" href="/lanjz/assets/js/216.1c6ed8c8.js"><link rel="prefetch" href="/lanjz/assets/js/217.1de4770a.js"><link rel="prefetch" href="/lanjz/assets/js/218.309d4d03.js"><link rel="prefetch" href="/lanjz/assets/js/219.2289755f.js"><link rel="prefetch" href="/lanjz/assets/js/22.ae3cfa62.js"><link rel="prefetch" href="/lanjz/assets/js/220.88284390.js"><link rel="prefetch" href="/lanjz/assets/js/23.6b4df7f3.js"><link rel="prefetch" href="/lanjz/assets/js/24.dd9c1d07.js"><link rel="prefetch" href="/lanjz/assets/js/25.ef5b986b.js"><link rel="prefetch" href="/lanjz/assets/js/26.ef098bf1.js"><link rel="prefetch" href="/lanjz/assets/js/27.59c08af4.js"><link rel="prefetch" href="/lanjz/assets/js/28.460aab55.js"><link rel="prefetch" href="/lanjz/assets/js/30.7a97a4f6.js"><link rel="prefetch" href="/lanjz/assets/js/31.41fc42bf.js"><link rel="prefetch" href="/lanjz/assets/js/32.ea296565.js"><link rel="prefetch" href="/lanjz/assets/js/33.564dab12.js"><link rel="prefetch" href="/lanjz/assets/js/34.b47ba6c0.js"><link rel="prefetch" href="/lanjz/assets/js/35.d35067b6.js"><link rel="prefetch" href="/lanjz/assets/js/36.69a98787.js"><link rel="prefetch" href="/lanjz/assets/js/37.328a829d.js"><link rel="prefetch" href="/lanjz/assets/js/38.30fc42a1.js"><link rel="prefetch" href="/lanjz/assets/js/39.45eeb15f.js"><link rel="prefetch" href="/lanjz/assets/js/4.95605dcb.js"><link rel="prefetch" href="/lanjz/assets/js/40.72868b87.js"><link rel="prefetch" href="/lanjz/assets/js/41.979116a9.js"><link rel="prefetch" href="/lanjz/assets/js/42.4519da86.js"><link rel="prefetch" href="/lanjz/assets/js/43.b986d374.js"><link rel="prefetch" href="/lanjz/assets/js/44.945667bc.js"><link rel="prefetch" href="/lanjz/assets/js/45.a8296544.js"><link rel="prefetch" href="/lanjz/assets/js/46.b42f7e5c.js"><link rel="prefetch" href="/lanjz/assets/js/47.64270408.js"><link rel="prefetch" href="/lanjz/assets/js/48.6a221702.js"><link rel="prefetch" href="/lanjz/assets/js/49.5655ff44.js"><link rel="prefetch" href="/lanjz/assets/js/5.ef2396a9.js"><link rel="prefetch" href="/lanjz/assets/js/50.d878962f.js"><link rel="prefetch" href="/lanjz/assets/js/51.1201953a.js"><link rel="prefetch" href="/lanjz/assets/js/52.c81be93e.js"><link rel="prefetch" href="/lanjz/assets/js/53.d7cf1355.js"><link rel="prefetch" href="/lanjz/assets/js/54.5ff0e1dc.js"><link rel="prefetch" href="/lanjz/assets/js/55.732d4f5d.js"><link rel="prefetch" href="/lanjz/assets/js/56.b7bc7a44.js"><link rel="prefetch" href="/lanjz/assets/js/57.a961b239.js"><link rel="prefetch" href="/lanjz/assets/js/58.1ca65b69.js"><link rel="prefetch" href="/lanjz/assets/js/59.8b9c37de.js"><link rel="prefetch" href="/lanjz/assets/js/6.72fbd8ee.js"><link rel="prefetch" href="/lanjz/assets/js/60.3367ccff.js"><link rel="prefetch" href="/lanjz/assets/js/61.323211b9.js"><link rel="prefetch" href="/lanjz/assets/js/62.0128f6e3.js"><link rel="prefetch" href="/lanjz/assets/js/63.34d6f229.js"><link rel="prefetch" href="/lanjz/assets/js/64.30be6931.js"><link rel="prefetch" href="/lanjz/assets/js/65.0a61834e.js"><link rel="prefetch" href="/lanjz/assets/js/66.fc458854.js"><link rel="prefetch" href="/lanjz/assets/js/67.53b5ace7.js"><link rel="prefetch" href="/lanjz/assets/js/68.c3136eb1.js"><link rel="prefetch" href="/lanjz/assets/js/69.a30b6775.js"><link rel="prefetch" href="/lanjz/assets/js/7.6b30531a.js"><link rel="prefetch" href="/lanjz/assets/js/70.fd2e18c5.js"><link rel="prefetch" href="/lanjz/assets/js/71.61dfb070.js"><link rel="prefetch" href="/lanjz/assets/js/72.9a52e654.js"><link rel="prefetch" href="/lanjz/assets/js/73.5269cbe2.js"><link rel="prefetch" href="/lanjz/assets/js/74.4f79ec09.js"><link rel="prefetch" href="/lanjz/assets/js/75.353def3c.js"><link rel="prefetch" href="/lanjz/assets/js/76.7eb13dc0.js"><link rel="prefetch" href="/lanjz/assets/js/77.922380d7.js"><link rel="prefetch" href="/lanjz/assets/js/78.d99a2fba.js"><link rel="prefetch" href="/lanjz/assets/js/79.d3a13953.js"><link rel="prefetch" href="/lanjz/assets/js/8.708e96e8.js"><link rel="prefetch" href="/lanjz/assets/js/80.1de655b9.js"><link rel="prefetch" href="/lanjz/assets/js/81.24328105.js"><link rel="prefetch" href="/lanjz/assets/js/82.9a94dbea.js"><link rel="prefetch" href="/lanjz/assets/js/83.60674923.js"><link rel="prefetch" href="/lanjz/assets/js/84.7fdd73af.js"><link rel="prefetch" href="/lanjz/assets/js/85.cec9a8be.js"><link rel="prefetch" href="/lanjz/assets/js/86.0a0858b0.js"><link rel="prefetch" href="/lanjz/assets/js/87.90c4fb50.js"><link rel="prefetch" href="/lanjz/assets/js/88.ca2e81a9.js"><link rel="prefetch" href="/lanjz/assets/js/89.a6922d02.js"><link rel="prefetch" href="/lanjz/assets/js/9.324f40f0.js"><link rel="prefetch" href="/lanjz/assets/js/90.01930918.js"><link rel="prefetch" href="/lanjz/assets/js/91.b1fc3755.js"><link rel="prefetch" href="/lanjz/assets/js/92.d6b3e8f8.js"><link rel="prefetch" href="/lanjz/assets/js/93.6bc4f5b9.js"><link rel="prefetch" href="/lanjz/assets/js/94.8c603165.js"><link rel="prefetch" href="/lanjz/assets/js/95.2407cc46.js"><link rel="prefetch" href="/lanjz/assets/js/96.32809d8f.js"><link rel="prefetch" href="/lanjz/assets/js/97.5073a7c0.js"><link rel="prefetch" href="/lanjz/assets/js/98.007a49c2.js"><link rel="prefetch" href="/lanjz/assets/js/99.1cfd8601.js">
    <link rel="stylesheet" href="/lanjz/assets/css/0.styles.e9edb4e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lanjz/" class="home-link router-link-active"><!----> <span class="site-name">Hello Wold</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lanjz/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/HTML5/" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/CSS/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Browser/" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络&amp;算法" class="dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络&amp;算法" class="mobile-dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/secure/" class="nav-link">
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Vue3/" class="nav-link">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/React/" class="nav-link router-link-active">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/qiankun/" class="nav-link">
  qiankun
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/NA/" class="nav-link">
  跨平台
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Node/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Api/" class="nav-link">
  API
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Package/" class="nav-link">
  yarn&amp;npm
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/ESBuild/" class="nav-link">
  esbuild
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/数据库/" class="nav-link">
  SQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端优化总结/" class="nav-link">
  前端优化总结
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/系统设计/" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/预加载&amp;预解析.html" class="nav-link">
  预加载&amp;预解析
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/重构改善既有代码的设计.html" class="nav-link">
  重构代码原则
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/开发与调试技巧.html" class="nav-link">
  开发与调试
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/组件设计的基本原则.html" class="nav-link">
  组件设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/公共模块管理.html" class="nav-link">
  公共模块管理
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/内存泄漏.html" class="nav-link">
  内存泄漏
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端异常捕获.html" class="nav-link">
  前端异常捕获
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/自动化部署.html" class="nav-link">
  自动化部署
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/疑难杂症.html" class="nav-link">
  问题小计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/性能指标.html" class="nav-link">
  性能指标
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="利其器" class="dropdown-title"><span class="title">利其器</span> <span class="arrow down"></span></button> <button type="button" aria-label="利其器" class="mobile-dropdown-title"><span class="title">利其器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Mac.html" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Github.html" class="nav-link">
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/lanjz/Im/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lanjz/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/HTML5/" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/CSS/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Browser/" class="nav-link">
  Browser
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络&amp;算法" class="dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络&amp;算法" class="mobile-dropdown-title"><span class="title">网络&amp;算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/secure/" class="nav-link">
  Web安全
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Vue3/" class="nav-link">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/React/" class="nav-link router-link-active">
  React
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/qiankun/" class="nav-link">
  qiankun
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/NA/" class="nav-link">
  跨平台
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node" class="dropdown-title"><span class="title">Node</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node" class="mobile-dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/Node/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Api/" class="nav-link">
  API
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Package/" class="nav-link">
  yarn&amp;npm
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/Vite/" class="nav-link">
  Vite
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/ESBuild/" class="nav-link">
  esbuild
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/Node/数据库/" class="nav-link">
  SQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端优化总结/" class="nav-link">
  前端优化总结
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/系统设计/" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/预加载&amp;预解析.html" class="nav-link">
  预加载&amp;预解析
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/重构改善既有代码的设计.html" class="nav-link">
  重构代码原则
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/开发与调试技巧.html" class="nav-link">
  开发与调试
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/组件设计的基本原则.html" class="nav-link">
  组件设计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/公共模块管理.html" class="nav-link">
  公共模块管理
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/内存泄漏.html" class="nav-link">
  内存泄漏
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/前端异常捕获.html" class="nav-link">
  前端异常捕获
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/自动化部署.html" class="nav-link">
  自动化部署
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/疑难杂症.html" class="nav-link">
  问题小计
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/工程化/性能指标.html" class="nav-link">
  性能指标
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="利其器" class="dropdown-title"><span class="title">利其器</span> <span class="arrow down"></span></button> <button type="button" aria-label="利其器" class="mobile-dropdown-title"><span class="title">利其器</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Mac.html" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/lanjz/利其器/Github.html" class="nav-link">
  Github
</a></li></ul></div></div><div class="nav-item"><a href="/lanjz/Im/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/lanjz/React/vsVue.html" class="sidebar-link">vsVue</a></li><li><a href="/lanjz/React/ReactDOM.render.html" class="sidebar-link">ReactDOM.render</a></li><li><a href="/lanjz/React/Fiber.html" class="sidebar-link">Fiber</a></li><li><a href="/lanjz/React/时间切片.html" class="sidebar-link">时间切片</a></li><li><a href="/lanjz/React/Diff.html" aria-current="page" class="active sidebar-link">React16 Diff</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#textnode" class="sidebar-link">TextNode</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#react-element" class="sidebar-link">React.Element</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#children-diff" class="sidebar-link">children diff</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#小结-3" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#placechild" class="sidebar-link">placeChild</a></li><li class="sidebar-sub-header"><a href="/lanjz/React/Diff.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/lanjz/React/高阶组件.html" class="sidebar-link">memo</a></li><li><a href="/lanjz/React/React16新特性.html" class="sidebar-link">React16新特性</a></li><li><a href="/lanjz/React/Hook.html" class="sidebar-link">Hook</a></li><li><a href="/lanjz/React/性能优化.html" class="sidebar-link">性能优化</a></li><li><a href="/lanjz/React/React高级指引.html" class="sidebar-link">高级指引</a></li><li><a href="/lanjz/React/服务端渲染.html" class="sidebar-link">React SSR</a></li><li><a href="/lanjz/React/吱不吱.html" class="sidebar-link">吱不吱</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react16-diff"><a href="#react16-diff" class="header-anchor">#</a> React16 Diff</h1> <p>React 以前的 Diff 算法就是基于树的，现在整体的数据结构改为了链表结构，链表的每一个节点是 Fiber</p> <p>React16 的 diff 策略采用从链表头部开始比较的算法，是层次遍历，算法是建立在一个节点的插入、删除、移动等操作且这些都是在节点树的同一层级中进行的</p> <p><code>reconcileChildFibers</code> 方法是开始 diff 的地方，简单看下源码：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里 就是 处理 &lt;&gt;&lt;/&gt; 这样的子节点的，因为 这样的 节点是 没有 key 的，就把内部的</span>
      <span class="token comment">// 子节点 统一处理 为 数组子节点</span>
      <span class="token keyword">var</span> isUnkeyedTopLevelFragment <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span> <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnkeyedTopLevelFragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newChild <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token keyword">var</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果新节点是对象类型也就是  REACT_ELEMENT_TYPE 或者 REACT_PORTAL_TYPE</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token constant">REACT_PORTAL_TYPE</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSinglePortal</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果新节点是文本类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> <span class="token string">''</span> <span class="token operator">+</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果新节点是数组类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray$1</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果新节点是包含迭代遍历器的，类型数组</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIteratorFn</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reconcileChildrenIterator</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">// ....</span>
      <span class="token comment">// 只有可能newChild === null，说明新的更新清空掉了所有子节点。</span>
      <span class="token keyword">return</span> <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>reconcileChildFibers(returnFiber, currentFirstChild, newChild, expirationTime)</code> 接收参数表示如下：</p> <ul><li><p><code>returnFiber</code>：是即将 Diff 的这层的父节点</p></li> <li><p><code>currentFirstChild</code>：是当前层的第一个 Fiber 节点</p></li> <li><p><code>newChildren</code>：即将更新的 vdom 节点(可能是 TextNode、可能是 ReactElement，可能是数组)，不是 Fiber 节点</p></li> <li><p><code>expirationTime</code>：过期时间（这里不讨论这个）</p></li></ul> <p>从上面的代码可以看出 diff 根据新节点的类型进行不同处理，这些类型会有四种情况</p> <ul><li><p>TextNode(包含字符串和数字)</p></li> <li><p>React Element(通过该节点是否有 $$typeof 区分)</p></li> <li><p>数组</p></li> <li><p>可迭代的 children，跟数组的处理方式差不多</p></li></ul> <p>下面针对不同的类型看下具体的 diff 实现</p> <h2 id="textnode"><a href="#textnode" class="header-anchor">#</a> TextNode</h2> <p>如果新节点是文本类型 eg:</p> <p><img src="/lanjz/assets/img/diff_1.3f197250.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> <span class="token string">''</span> <span class="token operator">+</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// reconcileSingleTextNode</span>
<span class="token keyword">function</span> <span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> textContent<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFirstChild <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> currentFirstChild<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果也是TextNode</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除后面的节点</span>
    <span class="token keyword">var</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>currentFirstChild<span class="token punctuation">,</span> textContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> created <span class="token operator">=</span> <span class="token function">createFiberFromText</span><span class="token punctuation">(</span>textContent<span class="token punctuation">,</span> returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span> created<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据代码走两个分支：</p> <ol><li>如果旧节点是 <code>TextNode</code> 则复用当前这个旧节点，更新新的文本内容</li></ol> <p>因为是文本节点，所以旧节点后面的兄弟节点是要被移除的所以会执行 <code>deleteRemainingChildren(returnFiber, currentFirstChild.sibling)</code> 删除旧节点兄弟节点<br>
最后返回这个节点</p> <ol start="2"><li>如果旧节点不是一个 <code>TextNode</code>，那么就代表这个节点不能复用，所以就执行 <code>deleteRemainingChildren(returnFiber, currentFirstChild)</code> 从 <code>currentFirstChild</code> 开始删掉剩余的节点。并通过 <code>createFiberFromText</code> 创建 <code>TextNode</code> 并添加到Fiber树中</li></ol> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>文字节点的对比比较简单粗暴，直接找老的 <code>children</code> 中的第一个节点，如果是文字节点就复用，如果不是就删除全部老的节点，创建新的文字节点</p> <h2 id="react-element"><a href="#react-element" class="header-anchor">#</a> React.Element</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// reconcileSingleElement</span>
<span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span> <span class="token parameter">returnFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> currentFirstChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> element<span class="token operator">:</span> ReactElement<span class="token punctuation">,</span> lanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span> <span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">switch</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
            <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
                existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
                <span class="token punctuation">{</span>
                  existing<span class="token punctuation">.</span>_debugSource <span class="token operator">=</span> element<span class="token punctuation">.</span>_source<span class="token punctuation">;</span>
                  existing<span class="token punctuation">.</span>_debugOwner <span class="token operator">=</span> element<span class="token punctuation">.</span>_owner<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>elementType <span class="token operator">===</span> element<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token comment">// Keep this check inline so it only runs on the false path:</span>
                <span class="token function">isCompatibleFamilyForHotReloading</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> element<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> _existing3 <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _existing3<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token function">coerceRef</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _existing3<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
                <span class="token punctuation">{</span>
                  _existing3<span class="token punctuation">.</span>_debugSource <span class="token operator">=</span> element<span class="token punctuation">.</span>_source<span class="token punctuation">;</span>
                  _existing3<span class="token punctuation">.</span>_debugOwner <span class="token operator">=</span> element<span class="token punctuation">.</span>_owner<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> _existing3<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token comment">// Didn't match.</span>
          <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>React Element Diff思路和 TextNode 是一致的：先找有没有可以复用的节点，如果没有就另外创建一个。如何判断这个节点是否可以复用呢？需要满足两个条件：</p> <ol><li><p><code>key</code> 相同</p></li> <li><p>节点的类型相同</p></li></ol> <p>注意上面的 <code>while</code>，说明查找可以复用的 React Element 节点，不是像 <code>TextNode</code> 一样只是找第一个 <code>child</code> 是否可以复用，而是采用遍历查找策略，在当前节点及其兄弟节点中搜索可复用的节点，之所以这么设计是考虑下面这种情况</p> <p><img src="/lanjz/assets/img/diff_2.22711629.png" alt=""></p> <p>如果没有找到可复用的节点则重新创建节点</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> created <span class="token operator">=</span> <span class="token function">createFiberFromFragment</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span> expirationTime<span class="token punctuation">,</span> element<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    <span class="token keyword">return</span> created<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _created4 <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _created4<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token function">coerceRef</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _created4<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    <span class="token keyword">return</span> _created4<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h3> <p>跟 <code>TextNode</code> 类似也是优先找可以复用的节点，但是要注意的是上面的 <code>while</code>，说明查找可以复用的 React Element 节点不像 <code>TextNode</code> 只是找第一个 <code>child</code> 是否可以复用，而是采用遍历查找策略，在当前节点及其兄弟节点中搜索可复用的节点。如果没有找到可复用的节点则重新创建节点</p> <h2 id="children-diff"><a href="#children-diff" class="header-anchor">#</a> children diff</h2> <p>子节点的 diff 逻辑主要在 <code>reconcileChildrenArray(returnFiber, currentFirstChild, newChildren, expirationTime)</code> 方法中，参数表示如下：</p> <ul><li><p>returnFiber：当前子节点对象的父节点</p></li> <li><p>currentFirstChild：旧节点</p></li> <li><p>newChildren：新节点</p></li> <li><p>expirationTime：过期时间（这里不讨论这个）</p></li></ul> <p><code>reconcileChildrenArray</code> 对子节点的 diff 主要是通过四步进行处理</p> <p><strong>一、首先对新旧相同位置(index)进行比较</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 每一次的循环都是对相同位置的新旧节点进行比较</span>
   <span class="token comment">// nextOldFiber 保存下一次遍历要对比的旧节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>index <span class="token operator">&gt;</span> newIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
      nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">;</span>
      oldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回复用的节点，如果没有可以复用的就返回 null</span>
    <span class="token keyword">var</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果newFiber的值为空的话，说明该节点不能复用，则跳出循环</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果是第一次渲染（即shouldTrackSideEffects为 true），并且 newFiber 没有要复用的 oldFiber 的话，则删除该 fiber 下的所有子节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> newFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 没有fiber</span>
        <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除旧节点</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将 newFiber 节点挂载到 DOM 树上，并判断更新后是否移动过，如果移动，则需要重新挂载，返回最新移动的 index，并赋值给lastPlacedIndex</span>
    lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 组成当前链</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span> <span class="token comment">// 指向下一个 旧节点</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>遍历新节点，对比相同位置（索引index）的新旧节点，重点在于 <code>updateSlot(returnFiber, oldFiber, newChildren[newIdx], expirationTime)</code> 的处理，这个方法执行的流程大致为：</p> <ol><li><p>尝试获取当前旧节点的 <code>key</code></p> <p><code>var key = oldFiber !== null ? oldFiber.key : null</code></p></li> <li><p>如果新节点是字符串或者数字，那么说明新节点是文本节点，此时根据上一步 <code>key</code> 是否为 <code>null</code> 做不同的处理</p> <ol><li><p>如果 <code>key!==null</code> 说明旧节点之前不是文本节点，那么说明新旧节点不同无法利用，则返回 <code>null</code></p></li> <li><p>如果 <code>key===null</code>，则通过 <code>updateTextNode(returnFiber, oldFiber, '' + newChild, expirationTime)</code> 更新文本</p></li></ol></li> <li><p>如果新节点是对象，也会根据上一步新旧节点的 <code>key</code> 是否相同做不同的处理</p> <ol><li><p>如果 <code>newChild.key === key</code> （这里只考虑正常的 ReactElement 元素）此时执行 <code>updateElement(returnFiber, _matchedFiber, newChild, expirationTime)</code> 进行节点的复用</p></li> <li><p>如果 <code>key</code> 不同则返回 <code>null</code></p></li></ol></li></ol> <p>所以 <code>updateSlot</code> 的结果要么为 <code>null</code>，要么为可复用的结果，之继续做以下步骤</p> <ol><li><p>如果新旧都为 <code>null</code>，应该表示没有需要 diff 节点了，直接退出当前循环</p></li> <li><p>移除旧节点</p></li> <li><p>使用 <code>newFiber</code> 生成链</p></li></ol> <p><strong>经过上一步的遍历后，如果新节点已经遍历完毕，对剩余新节点执行添加操作</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 新的 children 长度已经够了，所以把剩下的删除掉</span>
  <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// deleteRemainingChildren</span>
<span class="token keyword">function</span> <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Noop.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
  <span class="token keyword">var</span> childToDelete <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>childToDelete <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> childToDelete<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childToDelete <span class="token operator">=</span> childToDelete<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>returnFiber</code> 表示当前节点的父节点，<code>oldFiber</code> 表示要删除的节点，可以看到 <code>deleteRemainingChildren</code> 内部使用 <code>while</code> 循环删除所有的 <code>oldFiber</code> 节点</p> <p><strong>老节点已经遍历完毕后还存在新节点</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>_newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 创建一个链</span>
        resultingFirstChild <span class="token operator">=</span> _newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> _newFiber<span class="token punctuation">;</span> <span class="token comment">// 往这个链添加一个子节点</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> _newFiber<span class="token punctuation">;</span> <span class="token comment">// 更改当前链的位置</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如果旧节点遍历完，还存在新节点，则遍历剩余新节点通过 <code>createChild</code> 创建新节点，并添加到当前链当中</p> <p><strong>移动可复用的节点</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">var</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建 Map{key: fiber}，通过 key与 fiber映射在一起</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _newFiber2 <span class="token operator">=</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span>existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_newFiber2 <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_newFiber2<span class="token punctuation">.</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 移除已经复用的 map 值 </span>
          existingChildren<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>_newFiber2<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> newIdx <span class="token operator">:</span> _newFiber2<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>_newFiber2<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> _newFiber2<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> _newFiber2<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> _newFiber2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 还有剩余的旧节点，则遍历他们进行移除</span>
    existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
</code></pre></div><ol><li><p>这一步首先是通过 <code>mapRemainingChildren</code> 遍历旧节点，得到 <code>{key: fiber}</code> 的 <code>map</code> 结果</p></li> <li><p>遍历剩余新节点执行 <code>updateFromMap</code>， <code>updateFromMap</code> 的有以下几种情况</p> <ol><li><p>如果当前新节点只是数字或者字符串，则通过 <code>updateTextNode</code> 创建新的文本节点</p></li> <li><p>如果当新节点是对象且 <code>$$typeof===REACT_ELEMENT_TYPE</code> (表示是 <code>ReactElement</code> 创建的类型)，则尝试通过 <code>key</code> 在 <code>mapRemainingChildren</code> 找出复用的节点，没有重新创建</p></li> <li><p>还有其它情况暂时先忽略</p></li></ol></li> <li><p>如果在 <code>mapRemainingChildren</code> 中得到了可得用的节点，则移除当前 <code>key</code> 的映射</p></li> <li><p>如果遍历完之后 <code>mapRemainingChildren</code> 还有剩余的旧节点，则遍历他们进行移除</p></li></ol> <h3 id="小结-3"><a href="#小结-3" class="header-anchor">#</a> 小结</h3> <ul><li><p>首先遍历新数组，对相同 <code>index</code> 的新老节点进行对比，通过 <code>updateSlot</code> 方法找到可以复用的节点，直到找到不可以复用的节点就退出循环。</p></li> <li><p>首次遍历完之后，就是删除老数组中剩余的老节点，追加剩余的新节点的过程。如果是新节点已遍历完成，就将剩余的老节点批量删除；如果是老节点遍历完成仍有新节点剩余，则将新节点直接插入。</p></li> <li><p>上述遍历过程结束后，为了处理元素移动，最后会把所有老数组元素按 <code>key</code> 或 <code>index</code> 放 <code>Map</code> 里，然后再遍历新数组，从中找到复用的老数组元素插入到新数组中，达到移动元素目的。</p></li></ul> <h2 id="placechild"><a href="#placechild" class="header-anchor">#</a> placeChild</h2> <p>// todo</p> <p><code>lastPlacedIndex</code> 判断节点是否发生了移动 ?</p> <p>当复用的节点 <code>oldIndex小于lastPlacedIndex</code> 时，则为移动，如果不需要移动，则会将 <code>lastPlacedIndex</code> 更新为较大的 <code>oldIndex</code>，下一个节点会以新值判断</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIndex<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Noop.</span>
    <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldIndex <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
     <span class="token comment">// /移动了的节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&lt;</span> lastPlacedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 因为是移动的节点，所以要重新挂载到 DOM 上</span>
      newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
      <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有移动</span>
      <span class="token keyword">return</span> oldIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//current 为 null 说明该节点没有被渲染过</span>
    <span class="token comment">//所以是新插入的节点</span>
    newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
    <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>如果不是初次渲染的话（<code>shouldTrackSideEffects</code> 为 <code>true</code> ），无需更新 <code>shouldTrackSideEffects</code></p></li> <li><p><code>newFiber.alternate</code> 有值的话，说明是由旧节点更新来的，那么就需要比较 <code>oldIndex</code> 和 <code>lastPlacedIndex</code> ，有移动过的话，则返回 <code>lastPlacedIndex</code> ，否则返回 <code>oldIndex</code></p></li> <li><p><code>newFiber.alternate</code> 没有值的话，说明不是由旧节点更新来的，而是新插入的节点，返回 <code>lastPlacedIndex</code></p></li></ul> <p><img src="/lanjz/assets/img/diff_3.634469ac.png" alt=""></p> <p><strong>对比顺序</strong></p> <ol><li>如果可以找到 <code>key</code> 对应的节点，再对比类型，如果类型不同，就删除旧节点重新创建，</li></ol> <p>2、类型相同，对比 <code>lastPlacedIndex</code> 与 <code>oldIndex</code>，<code>lastPlacedIndex &lt;= oldIndex</code> 不需要移动，否则就需要移动位置，并且更新属性</p> <p>将A B C D E F修改为A C E B G 的执行顺序</p> <ul><li><p>lastPlacedIndex  = 0</p></li> <li><p>A在map里面存在，而且位置相同，复用节点更新属性</p></li> <li><p>C  对比 lastPlacedIndex &lt; oldIndex，lastPlacedIndex = 2，位置不动，只更新属性</p></li> <li><p>E  对比 lastPlacedIndex &lt; oldIndex，lastPlacedIndex = 4，位置不动，只更新属性</p></li> <li><p>B  对比 lastPlacedIndex &gt; oldIndex，需要移动位置并更新属性</p></li> <li><p>G  在map里找不到，需要创建并插入</p></li> <li><p>将map中剩余的元素 D F标记为删除</p></li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>对于新老节点的对比，React 以新节点为基础来构建整个 <code>currentInWorkProgress</code>，diff 过程对不同的节点类型执行不同的 diff 处理：</p> <p><strong>TextNode</strong></p> <p>判断老的 <code>children</code> 中的第一个节点是否也是文字节点，如果是就复用，如果不是就删除全部老的节点，创建新的文字节点</p> <p><strong>React.Element</strong></p> <p>优先在旧节点链中查找可以复用的节点，。如果没有找到可复用的节点则重新创建节点</p> <p><strong>children diff</strong></p> <ul><li><p>首先遍历新数组，对相同 <code>index</code> 的新老节点进行对比，通过 <code>updateSlot</code> 方法找到可以复用的节点，直到找到不可以复用的节点就退出循环。</p></li> <li><p>首次遍历完之后，就是删除老数组中剩余的老节点，追加剩余的新节点的过程。如果是新节点已遍历完成，就将剩余的老节点批量删除；如果是老节点遍历完成仍有新节点剩余，则将新节点直接插入。</p></li> <li><p>上述遍历过程结束后，为了处理元素移动，最后会把所有老数组元素按 <code>key</code> 或 <code>index</code> 放 <code>Map</code> 里，然后再遍历新数组，从中找到复用的老数组元素插入到新数组中，达到移动元素目的。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>React diff 的过程是层次遍历，类似迭代遍历，<code>workLoopSync</code> 每次都处理同一层的节点，之后返回子节点，如果有子节点继续调用 <code>performUnitOfWork</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Already timed out, so perform work without checking if we need to yield.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p><a href="http://article.docway.net/details?id=60a094570a6c64093cc74c6c" target="_blank" rel="noopener noreferrer">React 16的Diff 过程详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="http://kmanong.top/kmn/qxw/form/article?id=72653&amp;cate=85" target="_blank" rel="noopener noreferrer">K 码农<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lanjz/React/时间切片.html" class="prev">
        时间切片
      </a></span> <span class="next"><a href="/lanjz/React/高阶组件.html">
        memo
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/lanjz/assets/js/app.d8d1d3b2.js" defer></script><script src="/lanjz/assets/js/3.9b2a8784.js" defer></script><script src="/lanjz/assets/js/29.d4c2b5a1.js" defer></script>
  </body>
</html>
